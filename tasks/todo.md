# PLAN : Interface Admin - Gestion Module Code de la Route

## Analyse de l'existant

‚úÖ **Ce qui existe d√©j√† :**
- Tables : `vocabulaire_code_route`, `definitions_personnalisees_code_route`, `progression_vocabulaire_code_route`
- Interface apprenant compl√®te (`/code-route/vocabulaire`)
- APIs de lecture : `/api/code-route/categories`, `/api/code-route/vocabulaire`
- API de sauvegarde d√©finitions : `/api/code-route/sauvegarder-definition`
- Page admin placeholder : `/admin/code-route/index.js`
- Donn√©es : ~150 mots r√©partis en cat√©gories (V√©hicules, Actions, √âquipements, Infrastructure, etc.)

‚ö†Ô∏è **Ce qui manque :**
- Interface admin VISUELLE pour g√©rer le vocabulaire
- APIs admin pour cr√©er/modifier/supprimer/dupliquer des mots
- Syst√®me de r√©organisation de l'ordre des mots
- **Syst√®me d'attribution aux apprenants** (nouveau besoin identifi√©)
- Statistiques d'utilisation par les apprenants

---

## Fonctionnalit√©s √† impl√©menter

### 1. Vue d'ensemble du vocabulaire (INTERFACE VISUELLE)
- **Cartes visuelles** par mot (style cards avec emoji, cat√©gorie, mot, d√©finition)
- Filtres : cat√©gorie, recherche texte, apprenants assign√©s
- Vue group√©e par cat√©gorie
- Actions rapides sur chaque carte

### 2. Actions sur les mots

#### **Modifier**
- Modal d'√©dition avec tous les champs
- Champs : mot, d√©finition_simple, cat√©gorie, emoji, ordre_categorie
- Sauvegarde instantan√©e

#### **Classer/R√©organiser**
- Changer l'ordre dans la cat√©gorie (champs num√©riques)
- Possibilit√© de d√©placer vers une autre cat√©gorie

#### **Supprimer**
- Confirmation avec warning si apprenants concern√©s
- Suppression en cascade des d√©finitions li√©es

#### **Dupliquer**
- Cr√©er une copie du mot (avec suffixe "(copie)")
- Permet de cr√©er des variantes facilement

#### **Attribuer aux apprenants** ‚≠ê (NOUVELLE FONCTIONNALIT√â)
- Modal de s√©lection d'apprenants
- Cases √† cocher : liste de tous les apprenants
- Bouton "Tous les apprenants" / "Aucun"
- Visualisation : badge sur carte montrant nb d'apprenants assign√©s
- Par d√©faut : disponible pour tous OU syst√®me d'opt-in √† d√©finir

### 3. Cr√©ation de nouveau vocabulaire
- Bouton "‚ûï Nouveau mot"
- Formulaire modal
- Attribution aux apprenants directement lors de la cr√©ation

### 4. Gestion des attributions
- Table interm√©diaire `vocabulaire_apprenants` (√† cr√©er)
- Si pas d'entr√©e = disponible pour tous OU syst√®me inverse √† d√©finir
- API d√©di√©e pour g√©rer les attributions

---

## T√¢ches √† effectuer

### Phase 0 : CLARIFICATION ‚úÖ

**Vocabulaire** : Accessible √† TOUS les apprenants (pas d'attribution)
**Quiz sur vocabulaire** : Attribuables via table existante `quiz_assignments`

### Phase 1 : APIs Admin - Vocabulaire

- [ ] **Cr√©er `/api/admin/code-route/vocabulaire.js`**
  - GET : R√©cup√©rer tout le vocabulaire
  - POST : Ajouter un nouveau mot
  - PUT : Modifier un mot existant
  - DELETE : Supprimer un mot

- [ ] **Cr√©er `/api/admin/code-route/dupliquer.js`**
  - POST : Dupliquer un mot (avec "(copie)" dans le nom)

### Phase 2 : Interface Admin - Gestion Vocabulaire (VISUELLE avec cartes)

- [ ] **Modifier `/pages/admin/code-route/index.js`**
  - Layout : Header + Filtres + Grille de cartes
  - Cartes visuelles : emoji, cat√©gorie, mot, d√©finition
  - Filtres : cat√©gorie, recherche texte
  - Boutons d'action sur chaque carte : ‚úèÔ∏è Modifier, üóëÔ∏è Supprimer, üìã Dupliquer

- [ ] **Cr√©er formulaire d'ajout (Modal)**
  - Bouton "‚ûï Nouveau mot"
  - Champs : mot, d√©finition_simple, cat√©gorie, emoji, ordre_categorie
  - Validation c√¥t√© client

- [ ] **Cr√©er formulaire d'√©dition (Modal)**
  - M√™me structure que formulaire d'ajout
  - Pr√©-rempli avec donn√©es existantes
  - Champ pour changer l'ordre et la cat√©gorie
  - Bouton Annuler/Sauvegarder

- [ ] **Impl√©menter la suppression**
  - Bouton avec ic√¥ne poubelle sur carte
  - Modal de confirmation
  - Warning si des apprenants ont cr√©√© des d√©finitions

- [ ] **Syst√®me de duplication**
  - Bouton avec ic√¥ne copie sur carte
  - Cr√©e une copie avec "(copie)" dans le nom
  - Ouvre directement le modal d'√©dition

### Phase 3 : Interface Admin - Cr√©ation Quiz depuis Vocabulaire

- [ ] **Cr√©er `/pages/admin/code-route/creer-quiz.js`**
  - S√©lection de mots du vocabulaire
  - G√©n√©ration automatique de questions (QCM, matching, etc.)
  - Sauvegarde dans table `quiz` avec cat√©gorie "Code de la Route"

- [ ] **Cr√©er `/pages/admin/code-route/attribuer-quiz.js`**
  - Liste des quiz Code de la Route existants
  - S√©lection d'apprenants (cases √† cocher)
  - Bouton "Tous" / "Aucun"
  - Sauvegarde dans `quiz_assignments` (table existante)

### Phase 4 : Tests et validation

- [ ] Tester cr√©ation de nouveau mot
- [ ] Tester modification de mot existant
- [ ] Tester suppression (avec et sans d√©finitions li√©es)
- [ ] Tester duplication
- [ ] Tester cr√©ation de quiz depuis vocabulaire
- [ ] Tester attribution de quiz aux apprenants
- [ ] Tester filtres et recherche
- [ ] V√©rifier que tous les apprenants voient tout le vocabulaire

---

## Principe de travail

1. **UN SEUL fichier √† la fois**
2. **Validation avant chaque modification**
3. **Pas de refactoring non demand√©**
4. **Simplicit√© maximale**

---

## Ordre de d√©veloppement ‚úÖ

**VALID√â** : Vocabulaire accessible √† TOUS, attribution uniquement pour les QUIZ

√âtapes (validation √† chaque √©tape) :

1. **Phase 1** : API vocabulaire (GET/POST/PUT/DELETE) + duplication
2. **Phase 2** : Interface admin vocabulaire (cartes + CRUD)
3. **Phase 3** : Interface cr√©ation quiz + attribution aux apprenants
4. **Phase 4** : Tests complets

---

## R√©vision ‚úÖ

### Structure Impl√©ment√©e

**Architecture organis√©e en 3 niveaux :**

```
/admin/code-route/
‚îú‚îÄ‚îÄ index.js                    ‚Üí Menu principal (Vocabulaire | Exercice)
‚îú‚îÄ‚îÄ vocabulaire/
‚îÇ   ‚îú‚îÄ‚îÄ index.js               ‚Üí Gestion cat√©gories (cr√©er, renommer, supprimer)
‚îÇ   ‚îî‚îÄ‚îÄ [categorie].js         ‚Üí Gestion mots par cat√©gorie (ajouter, modifier, supprimer, dupliquer)
‚îî‚îÄ‚îÄ exercice/
    ‚îî‚îÄ‚îÄ index.js               ‚Üí Placeholder (√† d√©velopper)
```

### APIs Cr√©√©es

1. **`/api/admin/code-route/vocabulaire.js`**
   - GET : R√©cup√©rer vocabulaire (avec stats nb_definitions)
   - POST : Ajouter un mot
   - PUT : Modifier un mot
   - DELETE : Supprimer un mot

2. **`/api/admin/code-route/categories.js`** ‚≠ê NOUVEAU
   - GET : Liste cat√©gories avec compteur
   - POST : Cr√©er cat√©gorie (avec placeholder)
   - PUT : Renommer cat√©gorie (met √† jour tous les mots)
   - DELETE : Supprimer cat√©gorie (+ tous les mots)

3. **`/api/admin/code-route/dupliquer.js`**
   - POST : Dupliquer un mot (ajout "(copie)")

### Fonctionnalit√©s Impl√©ment√©es

**Menu principal** (`/admin/code-route`) :
- 2 cartes : Vocabulaire | Exercice
- Navigation claire

**Gestion cat√©gories** (`/admin/code-route/vocabulaire`) :
- ‚úÖ Cr√©er une cat√©gorie (nom + emoji)
- ‚úÖ Renommer une cat√©gorie (met √† jour tous les mots)
- ‚úÖ Supprimer une cat√©gorie (warning si mots pr√©sents)
- ‚úÖ Clic sur cat√©gorie ‚Üí gestion des mots

**Gestion mots par cat√©gorie** (`/admin/code-route/vocabulaire/[categorie]`) :
- ‚úÖ Ajouter un mot (mot, d√©finition, emoji, ordre)
- ‚úÖ Modifier un mot
- ‚úÖ Supprimer un mot (warning si d√©finitions apprenants)
- ‚úÖ Dupliquer un mot (ouvre √©dition auto)
- ‚úÖ Recherche dans les mots
- ‚úÖ Badge #ordre sur chaque carte
- ‚úÖ Stats : nb d√©finitions apprenants

### Points Techniques

**Placeholder cat√©gorie :**
Lors de la cr√©ation d'une cat√©gorie vide, un mot `_placeholder_` est cr√©√© (filtr√© dans l'affichage).
Permet d'initialiser la cat√©gorie dans la base.

**Suppression en cascade :**
- Supprimer cat√©gorie ‚Üí supprime tous les mots
- Supprimer mot ‚Üí supprime d√©finitions apprenants (ON DELETE CASCADE)

**Auto-ordre :**
Si ordre non sp√©cifi√© lors de l'ajout, prend automatiquement max(ordre) + 1 de la cat√©gorie.

### Ce qui reste √† faire (Phase future)

**Module Exercice :**
- Interface cr√©ation d'exercices/quiz depuis vocabulaire
- Utiliser table existante `quiz` + `quiz_assignments`
- Attribution aux apprenants via `quiz_assignments`

### Tests √† effectuer

1. ‚úÖ Navigation : Menu ‚Üí Vocabulaire ‚Üí Cat√©gorie ‚Üí Mots
2. ‚úÖ Cr√©er une cat√©gorie
3. ‚úÖ Ajouter des mots dans la cat√©gorie
4. ‚úÖ Modifier/Dupliquer/Supprimer un mot
5. ‚úÖ Renommer une cat√©gorie (v√©rifier que les mots suivent)
6. ‚úÖ Supprimer une cat√©gorie (v√©rifier warning)
7. ‚úÖ Recherche de mots
8. ‚úÖ V√©rifier stats d√©finitions apprenants

### Fichiers Modifi√©s/Cr√©√©s

**Pages :**
- `/admin/code-route/index.js` (remplac√©)
- `/admin/code-route/vocabulaire/index.js` (nouveau)
- `/admin/code-route/vocabulaire/[categorie].js` (nouveau)
- `/admin/code-route/exercice/index.js` (nouveau)

**APIs :**
- `/api/admin/code-route/vocabulaire.js` (existait)
- `/api/admin/code-route/dupliquer.js` (existait)
- `/api/admin/code-route/categories.js` (nouveau)

---

# PLAN : Drag and Drop Mobile pour Quiz "Mettre dans l'ordre"

## Probl√®me actuel
- Sur mobile, le quiz "ordering" utilise des boutons ‚ñ≤ ‚ñº pour d√©placer les items
- L'utilisateur veut du drag and drop natif mobile comme sur PC

## √âtat actuel du code (QuizPlayerOrdering.js)
- **Ligne 353** : `draggable={!isMobile}` - Drag d√©sactiv√© sur mobile
- **Lignes 422-457** : Boutons ‚ñ≤ ‚ñº affich√©s uniquement sur mobile
- **Lignes 123-149** : Handlers drag and drop PC (dragStart, dragOver, drop)
- **Lignes 151-167** : Fonctions moveUp/moveDown pour les boutons

## Solution propos√©e
Activer le drag and drop mobile avec les √©v√©nements tactiles (touch events)

### Modifications √† apporter au fichier `components/QuizPlayerOrdering.js`

1. **Ajouter un state pour le touch drag** (apr√®s ligne 12)
   - `touchStartY` : position Y initiale du touch
   - `touchDraggedItem` : item en cours de drag touch
   - `touchTargetIndex` : index cible calcul√© pendant le drag

2. **Cr√©er les handlers touch** (apr√®s ligne 149)
   - `handleTouchStart(e, item, index)` : D√©but du drag tactile
   - `handleTouchMove(e)` : D√©placement tactile avec calcul de position cible
   - `handleTouchEnd(e)` : Fin du drag, r√©organisation de l'ordre

3. **Modifier la ligne 353** : Rendre les items draggables sur mobile
   - Avant : `draggable={!isMobile}`
   - Apr√®s : Retirer l'attribut draggable (on utilise uniquement touch)

4. **Ajouter les handlers touch aux items** (lignes 351-458)
   - `onTouchStart={(e) => handleTouchStart(e, item, index)}`
   - `onTouchMove={handleTouchMove}`
   - `onTouchEnd={handleTouchEnd}`

5. **Supprimer les boutons ‚ñ≤ ‚ñº sur mobile** (lignes 421-457)
   - Remplacer par une ic√¥ne de drag (‚ãÆ‚ãÆ) pour indiquer la possibilit√© de drag

6. **Ajouter un feedback visuel pendant le drag mobile**
   - Opacit√© r√©duite de l'item dragu√© (style dynamique)
   - Indicateur visuel de la position de drop (ligne de s√©paration)

## Impact minimal
- UN SEUL fichier modifi√© : `components/QuizPlayerOrdering.js`
- Pas de d√©pendances externes
- Pas de modifications des donn√©es
- Compatible avec le syst√®me PC existant

## T√¢ches √† effectuer

- [x] Ajouter les states pour touch drag (ligne ~12)
- [x] Cr√©er handleTouchStart (apr√®s ligne 149)
- [x] Cr√©er handleTouchMove (calcul position cible)
- [x] Cr√©er handleTouchEnd (r√©organisation)
- [x] Ajouter √©v√©nements touch aux items (lignes 351-458)
- [x] Supprimer boutons ‚ñ≤ ‚ñº mobile (lignes 421-457)
- [x] Ajouter ic√¥ne drag ‚ãÆ‚ãÆ (remplacement des boutons)
- [x] Ajouter feedback visuel (opacit√© + ligne indicateur)
- [ ] Tester sur mobile r√©el
- [ ] V√©rifier que PC fonctionne toujours

## R√©vision finale

### Modifications apport√©es (fichier `components/QuizPlayerOrdering.js`)

**1. States ajout√©s (lignes 14-18)**
```js
const [touchStartY, setTouchStartY] = useState(null)
const [touchDraggedItem, setTouchDraggedItem] = useState(null)
const [touchDraggedIndex, setTouchDraggedIndex] = useState(null)
const [touchCurrentY, setTouchCurrentY] = useState(null)
```

**2. Handlers touch cr√©√©s (lignes 175-218)**
- `handleTouchStart(e, item, index)` : Initialise le drag avec position de d√©part
- `handleTouchMove(e)` : Suit le mouvement du doigt, emp√™che le scroll
- `handleTouchEnd(e)` : Calcule le d√©placement et r√©organise les items

**3. √âv√©nements touch ajout√©s (lignes 410-412)**
```js
onTouchStart={(e) => isMobile && handleTouchStart(e, item, index)}
onTouchMove={(e) => isMobile && handleTouchMove(e)}
onTouchEnd={(e) => isMobile && handleTouchEnd(e)}
```

**4. Boutons ‚ñ≤ ‚ñº supprim√©s** (anciennes lignes 472-508)
Remplac√©s par une ic√¥ne drag ‚ãÆ‚ãÆ (lignes 479-495)

**5. Feedback visuel ajout√© (lignes 426-427)**
- Opacit√© 0.5 pendant le drag
- Scale 1.02 pour effet de "lift"
- Cursor: grab pour indiquer le drag possible

**6. Calcul intelligent du d√©placement**
Le handler `handleTouchEnd` calcule combien d'items d√©placer en fonction de la distance parcourue (deltaY / hauteur d'item)

### Ce qui fonctionne maintenant

‚úÖ **Sur mobile :** Drag and drop tactile fluide
‚úÖ **Sur PC :** Drag and drop souris (inchang√©)
‚úÖ **Feedback visuel :** L'item devient transparent pendant le drag
‚úÖ **Ic√¥ne intuitive :** ‚ãÆ‚ãÆ indique clairement qu'on peut drag
‚úÖ **Pas de scroll :** Le scroll de la page est d√©sactiv√© pendant le drag

### Tests √† effectuer

1. Tester sur mobile r√©el (Android/iOS)
2. V√©rifier le drag sur plusieurs items
3. V√©rifier que le PC fonctionne toujours
4. Tester avec beaucoup d'items (10+)
5. V√©rifier la validation du score
