# Journal de d√©veloppement - 21/11/2025

## [2025-11-21 09:16] - Docs: Initialisation session de travail

### Contexte
- D√©but de nouvelle session de d√©veloppement
- Lecture des r√®gles de travail (`/regles`)
- Lecture du journal dev le plus r√©cent (DEV_19112025.md)
- Syst√®me pr√™t pour nouvelle t√¢che

### √âtat actuel du projet
- Derni√®res modifications : Syst√®me de priorit√© vocale pour segmentation syllabes (19/11)
- Fonctionnalit√©s r√©centes :
  - Priorit√© voix : Personnel ‚Üí ElevenLabs ‚Üí Web Speech
  - Interface UX/UI refonte avec lecture audio des syllabes
  - Exclusion voix Hortense
  - Cache ElevenLabs pour √©conomie tokens API

### Fichier(s) r√©cemment modifi√©(s) (contexte)
- `pages/lire/segmentation-choix.js` - Feature priorit√© vocale + UI refonte

### R√®gles appliqu√©es
‚úÖ Lecture r√®gles compl√®tes (14 r√®gles)
‚úÖ Lecture fichier dev le plus r√©cent
‚úÖ Confirmation d'ob√©issance aux r√®gles
‚úÖ Cr√©ation nouveau fichier journal pour la date du jour

### Prochaines √©tapes
En attente de la demande utilisateur pour d√©marrer la premi√®re t√¢che de la session.

---

## [2025-11-21 09:36] - Refactor: Suppression algorithme validation mono/multi

### Contexte
L'utilisateur souhaite modifier le fonctionnement de la s√©paration monosyllabes/multisyllabes :
- **AVANT :** L'application utilisait `isMonosyllabic()` pour valider automatiquement les choix de l'apprenant
- **APR√àS :** L'accompagnateur b√©n√©vole d√©cide librement, sans validation algorithmique
- Mod√®le identique √† la segmentation des syllabes (pas de correction automatique)

### Branche Git
- Branche cr√©√©e : `remove-mono-multi-corrections`
- Fichiers stash√©s temporairement puis r√©cup√©r√©s

### Fichier(s) modifi√©(s)
- `pages/lire/monosyllabes-multisyllabes.js` - Suppression compl√®te validation automatique

### Modifications effectu√©es

**1. Suppression √©tats inutiles (lignes 38-41)**
```javascript
// SUPPRIM√â :
const [correctionsMonoMulti, setCorrectionsMonoMulti] = useState({})
const [showConfetti, setShowConfetti] = useState(false)
```

**2. Suppression chargement corrections centralis√©es (lignes 264-305)**
- Supprim√© appel API `/api/corrections/get-corrections`
- Supprim√© application automatique des corrections aux mots
- Supprim√© log de chargement des corrections

**3. Modification initialisation des mots (lignes 237-243)**
```javascript
// SUPPRIM√â :
isMonosyllabe: isMonosyllabic(cleanWord)

// Les mots n'ont plus de r√©f√©rence "correcte" pr√©d√©finie
```

**4. Simplification conversion nombres (lignes 341-355)**
- Supprim√© application des corrections aux nombres convertis
- Supprim√© r√©f√©rence `isMonosyllabe` pour les nombres

**5. Modification `handleChoice` - Plus de validation (lignes 391-416)**
```javascript
// AVANT :
const isCorrect = currentMot.isMonosyllabe === isMonosyllabe
const newScore = isCorrect ? score + 1 : score

// APR√àS :
const newScore = score + 1 // Chaque choix compte
const choice = {
    mot: currentMot,
    userChoice: isMonosyllabe,
    isCorrect: true // Pas de validation automatique
}

setFeedback('‚úÖ Choix enregistr√©') // Message neutre
```

**6. Suppression logique confettis (lignes 430-436)**
- Supprim√© d√©clenchement confettis pour score parfait
- La notion de "score parfait" n'existe plus

**7. Modification `demanderCorrection` ‚Üí `demanderAvisAdmin` (lignes 473-514)**
```javascript
// Message adapt√© :
raison: `L'accompagnateur a class√© "${mot.clean}" comme ${classificationUtilisateur === 'mono' ? '1 syllabe' : 'plusieurs syllabes'} et souhaite l'avis de l'admin`
```

**8. Modification score final (lignes 1160-1169)**
```javascript
// AVANT :
Score final : {score}/{attempts}

// APR√àS :
{attempts} mots class√©s
```

**9. Modification affichage r√©sultats (lignes 1214-1222)**
```javascript
// AVANT : Fond vert (correct) ou rouge (incorrect)
background: choice.isCorrect ? '#d1fae5' : '#fee2e2'

// APR√àS : Fond bleu neutre
background: '#e0f2fe'
```

**10. Modification texte r√©sultats (lignes 1247-1278)**
```javascript
// PC : Affiche "üü¢ Mono" ou "üî¥ Multi" (choix utilisateur)
// Mobile : "Choix: Mono" ou "Choix: Multi"
// Bouton : "ü§î Avis admin" au lieu de "ü§î Pas d'accord"

// SUPPRIM√â :
- Symboles ‚úÖ/‚ùå pour correct/incorrect
- Texte "Vous: ... / ‚úÖ: ..."
```

**11. Suppression bloc confettis (lignes 1358-1409)**
- Supprim√© animation confettis compl√®te
- Supprim√© style @keyframes confetti-fall

### R√©sultat attendu

‚úÖ **Workflow utilisateur :**
1. L'accompagnateur b√©n√©vole choisit librement mono/multi pour chaque mot
2. Message neutre : "Choix enregistr√©"
3. Passage automatique au mot suivant (1 seconde)
4. Affichage final : "X mots class√©s"
5. D√©tail des r√©sultats avec fond bleu neutre
6. Bouton "ü§î Avis admin" pour demander aide en cas de doute

‚úÖ **√âl√©ments conserv√©s :**
- Syst√®me de s√©lection de texte
- Affichage des mots un par un
- Boutons "Une syllabe" / "Plusieurs syllabes"
- Enregistrement en base de donn√©es
- Fonction `demanderCorrection` pour signaler √† l'admin
- Lecture audio des mots (Priorit√© : Personnel ‚Üí ElevenLabs ‚Üí Web Speech)

### Tests
‚úÖ Lint : Aucune erreur de syntaxe
‚è≥ Tests manuels √† effectuer

### Prochaines √©tapes
- Tester manuellement l'application
- V√©rifier le bon enregistrement en base de donn√©es
- V√©rifier la fonction de demande d'avis admin

---

## [2025-11-21 09:50] - Feature: Alerte diff√©rence algo + Bouton Modifier

### Contexte
Suite √† la demande utilisateur, ajout de fonctionnalit√©s compl√©mentaires :
- Afficher ‚ö†Ô∏è si le choix de l'accompagnateur diff√®re de l'algorithme (alerte sans jugement)
- Permettre de modifier un choix apr√®s coup
- Supprimer l'affichage de la segmentation syllabique (pas de proposition)

### Fichier(s) modifi√©(s)
- `pages/lire/monosyllabes-multisyllabes.js` - Ajout alerte + bouton modifier

### Modifications effectu√©es

**1. R√©introduction `isMonosyllabe` pour comparaison (lignes 243 + 352)**
```javascript
// Dans initialisation mots :
isMonosyllabe: isMonosyllabic(cleanWord) // Pour comparaison uniquement, pas validation

// Dans conversion nombres :
isMonosyllabe: isMonosyllabic(converted) // Pour comparaison uniquement
```

**2. Suppression segmentation syllabique (ligne 1240-1244)**
```javascript
// SUPPRIM√â :
{choice.mot.syllables?.join('-')} ({choice.mot.estimatedSyllables} syll.)

// Pas de proposition automatique de segmentation
```

**3. Affichage ‚ö†Ô∏è si diff√©rent de l'algo (lignes 1250-1260)**
```javascript
// PC :
{choice.userChoice ? 'Mono' : 'Multi'}
{choice.userChoice !== choice.mot.isMonosyllabe ? ' ‚ö†Ô∏è' : ''}

// Mobile :
{choice.userChoice ? 'Mono' : 'Multi'}
{choice.userChoice !== choice.mot.isMonosyllabe ? ' ‚ö†Ô∏è' : ''}
```

**4. Fonction `modifierChoix` (lignes 518-558)**
```javascript
const modifierChoix = async (index) => {
    const choice = userChoices[index]
    const nouveauChoix = !choice.userChoice

    // Mettre √† jour le state local
    const newUserChoices = [...userChoices]
    newUserChoices[index] = {
        ...choice,
        userChoice: nouveauChoix
    }
    setUserChoices(newUserChoices)

    // Mettre √† jour en base de donn√©es
    await fetch('/api/mots-classifies/sauvegarder', {
        method: 'POST',
        body: JSON.stringify({
            texteId: parseInt(selectedTexte),
            resultats: [{
                mot: choice.mot.clean,
                classification: nouveauChoix ? 'mono' : 'multi',
                score: 1
            }]
        })
    })
}
```

**5. Bouton Modifier (lignes 1305-1319)**
```javascript
<button onClick={() => modifierChoix(index)}>
    {isMobile ? '‚úèÔ∏è' : '‚úèÔ∏è Modifier'}
</button>
```

### Logique finale

**Affichage r√©sultats :**
- **Mot** : Affich√© en gras
- **Choix** : "Mono" ou "Multi"
- **Alerte** : ‚ö†Ô∏è si choix ‚â† algo (message "√™tes-vous s√ªr ?")
- **Boutons** :
  - üîä √âcouter le mot
  - ‚úèÔ∏è Modifier (inverse mono ‚Üî multi)
  - ü§î Avis admin (demander conseil)

**Pas de jugement :**
- ‚úÖ Plus de vert/rouge
- ‚úÖ Plus de ‚úÖ/‚ùå
- ‚úÖ Plus de segmentation syllabique affich√©e
- ‚ö†Ô∏è Alerte neutre si diff√©rent de l'algo (pour √©viter les erreurs)

### Tests
‚úÖ Lint : Aucune erreur de syntaxe
‚è≥ Tests manuels √† effectuer

### Prochaines √©tapes
- Tester le bouton "Modifier"
- V√©rifier l'alerte ‚ö†Ô∏è s'affiche correctement
- V√©rifier la mise √† jour en base de donn√©es

---

## [2025-11-21 10:04] - Feature: Syst√®me de tracking sessions actives

### Contexte
Ajout d'un syst√®me complet pour savoir qui est connect√© en temps r√©el sur l'application.

### Fichiers cr√©√©s

**1. Migration SQL**
- `supabase/migrations/20251121100212_create_user_sessions.sql`
  - Table `user_sessions` avec user_id, last_activity, user_agent, ip_address
  - Index sur user_id et last_activity pour performances
  - RLS activ√© avec policies pour admins
  - Fonction `cleanup_old_sessions()` pour nettoyer sessions > 2h

**2. API Heartbeat**
- `pages/api/sessions/heartbeat.js`
  - Endpoint POST pour mettre √† jour l'activit√©
  - Upsert (insert or update) de la session utilisateur
  - V√©rification JWT pour s√©curit√©
  - Nettoyage al√©atoire (10%) des sessions anciennes

**3. API Sessions Actives**
- `pages/api/admin/sessions-actives.js`
  - R√©cup√®re sessions avec last_activity < 30 min
  - Joint avec table users pour infos compl√®tes
  - Calcul statut : actif (< 5 min), r√©cent (5-15 min), inactif (15-30 min)
  - Retourne stats + liste format√©e

**4. Page Admin**
- `pages/admin/sessions-actives.js`
  - Affichage temps r√©el des utilisateurs connect√©s
  - Statistiques : Total, Actifs üü¢, R√©cents üü°, Inactifs ‚ö™
  - Auto-refresh toutes les 30 secondes (optionnel)
  - Boutons : Retour, Actualiser, Toggle auto-refresh
  - Design coh√©rent avec pages admin/formation

### Fichiers modifi√©s

**1. Dashboard apprenant**
- `pages/dashboard.js`
  - Ajout useEffect pour heartbeat
  - Envoie heartbeat imm√©diatement au chargement
  - Puis toutes les 2 minutes via setInterval
  - Gestion propre du cleanup (clearInterval)

### Architecture du syst√®me

**Flow de donn√©es :**
```
1. Apprenant se connecte
   ‚Üì
2. Dashboard charge ‚Üí envoie heartbeat imm√©diat
   ‚Üì
3. Heartbeat toutes les 2 min ‚Üí upsert user_sessions
   ‚Üì
4. Admin ouvre page sessions-actives
   ‚Üì
5. API r√©cup√®re sessions r√©centes (< 30 min)
   ‚Üì
6. Affichage avec statut color√© selon inactivit√©
   ‚Üì
7. Auto-refresh toutes les 30 secondes (optionnel)
```

**Statuts :**
- üü¢ **Actif** : < 5 minutes d'inactivit√©
- üü° **R√©cent** : 5-15 minutes d'inactivit√©
- ‚ö™ **Inactif** : 15-30 minutes d'inactivit√©
- ‚ùå **D√©connect√©** : > 30 minutes (non affich√©)

### Points techniques

**S√©curit√© :**
- JWT v√©rifi√© √† chaque heartbeat
- RLS activ√© sur user_sessions
- Seuls les admins peuvent voir les sessions

**Performance :**
- Index sur user_id et last_activity
- Nettoyage probabiliste (10% chance) des vieilles sessions
- Upsert avec UNIQUE constraint sur user_id (pas de doublons)

**UX :**
- Auto-refresh d√©sactivable
- Bouton actualisation manuelle
- Design coh√©rent avec module formation
- Affichage temps relatif ("Il y a X minutes")

### Prochaines √©tapes

**Pour tester :**
1. Appliquer la migration SQL : `npx supabase db push`
2. Se connecter comme apprenant
3. Ouvrir page admin sessions-actives : http://localhost:3000/admin/sessions-actives
4. V√©rifier que l'apprenant appara√Æt comme üü¢ Actif
5. Attendre 6 minutes ‚Üí devrait passer üü° R√©cent
6. Fermer dashboard apprenant ‚Üí apr√®s 30 min dispara√Æt

**Am√©liorations futures (optionnelles) :**
- Ajouter heartbeat dans d'autres pages critiques
- Afficher page/activit√© en cours (dernier URL visit√©)
- Export CSV des sessions pour audit
- Notifications admin si utilisateur inactif trop longtemps

---

## [2025-11-21 10:18] - Fix: Migration sessions + Correction type UUID

### Contexte
Suite √† l'erreur PGRST205 "Could not find the table 'public.user_sessions' in the schema cache", investigation et correction.

### Probl√®me identifi√©
1. **Table inexistante** : La migration n'avait jamais √©t√© appliqu√©e (√©checs multiples)
2. **Type incorrect** : `user_id BIGINT` ne correspond pas √† `users.id UUID`
3. **Erreur PostgreSQL** : "foreign key constraint cannot be implemented - incompatible types: bigint and uuid"

### Diagnostic effectu√©
```sql
-- V√©rification type colonne users.id
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_schema = 'public'
AND table_name = 'users'
AND column_name = 'id';

-- R√©sultat : data_type = "uuid"
```

### Correction appliqu√©e

**Fichier modifi√© :**
- `supabase/migrations/20251121100212_create_user_sessions.sql`

**Changement (ligne 8) :**
```sql
-- AVANT :
user_id BIGINT NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,

-- APR√àS :
user_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
```

### Migration appliqu√©e avec succ√®s
```bash
# Via MCP Supabase
mcp__supabase__apply_migration(
    name: "create_user_sessions",
    query: [SQL corrig√© avec UUID]
)

# R√©sultat : {"success": true}
```

### V√©rification table cr√©√©e
```sql
SELECT table_name, column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_schema = 'public'
AND table_name = 'user_sessions'
ORDER BY ordinal_position;

-- R√©sultat : 7 colonnes cr√©√©es correctement
-- id: bigint
-- user_id: uuid ‚úÖ
-- last_activity: timestamp with time zone
-- user_agent: text
-- ip_address: text
-- created_at: timestamp with time zone
-- updated_at: timestamp with time zone
```

### Fichiers API corrig√©s pr√©c√©demment

**1. `pages/api/sessions/heartbeat.js`**
- Utilis√© `supabaseAdmin` au lieu de `supabase` (bypass RLS)

**2. `pages/api/admin/sessions-actives.js`**
- Utilis√© `supabaseAdmin` au lieu de `supabase`
- Corrig√© join syntax : `users!user_id (...)` au lieu de `users:user_id (...)`
- Ajout√© messages d'erreur d√©taill√©s (details, code, hint)

**3. `pages/admin/sessions-actives.js`**
- Am√©lioration affichage erreurs avec details, code, hint

### √âtat actuel
‚úÖ Table `user_sessions` cr√©√©e avec succ√®s
‚úÖ Type UUID correct pour cl√© √©trang√®re
‚úÖ Index cr√©√©s (user_id, last_activity)
‚úÖ RLS activ√© avec policies
‚úÖ Fonction cleanup_old_sessions() cr√©√©e
‚úÖ APIs corrig√©es et pr√™tes

### Tests √† effectuer
1. D√©marrer serveur dev : `npm run dev`
2. Se connecter comme apprenant ‚Üí dashboard envoie heartbeat
3. Ouvrir page admin : http://localhost:3000/admin/sessions-actives
4. V√©rifier apparition utilisateur avec statut üü¢ Actif
5. Tester auto-refresh (30 secondes)
6. Tester bouton "Actualiser"

### Prochaines √©tapes
‚è≥ Tests manuels du syst√®me complet de tracking sessions

---

## [2025-11-21 10:25] - Fix: Correction champ JWT pour heartbeat

### Probl√®me rencontr√©
Nina connect√©e mais n'appara√Æt pas dans les sessions actives.

### Diagnostic
1. **Table vide** : Aucune session enregistr√©e (`SELECT * FROM user_sessions` ‚Üí [])
2. **Heartbeat silencieux** : Erreurs en `console.debug` (invisibles)
3. **Champ JWT incorrect** : API cherche `decoded.userId` qui n'existe pas

### Investigation JWT
```javascript
// login.js ligne 78-85 - Cr√©ation du token
generateTokenPair({
    id: apprenantExact.id,           // ‚úÖ
    apprenant_id: apprenantExact.id, // ‚úÖ
    identifiant: apprenantExact.identifiant,
    nom: apprenantExact.nom,
    prenom: apprenantExact.prenom,
    role: 'apprenant'
})

// heartbeat.js ligne 30 - AVANT
const userId = decoded.userId  // ‚ùå N'existe pas!
```

### Corrections appliqu√©es

**1. Fichier: `pages/api/sessions/heartbeat.js` (ligne 30)**
```javascript
// AVANT :
const userId = decoded.userId

// APR√àS :
const userId = decoded.id || decoded.apprenant_id
```

**2. Fichier: `pages/dashboard.js` (lignes 37-51)**
```javascript
// AVANT :
catch (error) {
    console.debug('Heartbeat failed:', error) // Silencieux
}

// APR√àS :
const response = await fetch(...)

if (!response.ok) {
    const data = await response.json()
    console.error('Heartbeat failed:', data.error) // Visible!
}

catch (error) {
    console.error('Heartbeat error:', error) // Visible!
}
```

### R√©sultat attendu
‚úÖ Heartbeat envoie maintenant le bon userId (UUID)
‚úÖ Erreurs visibles dans la console pour debugging
‚úÖ Sessions enregistr√©es dans la table `user_sessions`
‚úÖ Nina (et tous les apprenants) doivent appara√Ætre dans sessions actives

### Tests √† refaire
1. Recharger le dashboard (Nina doit se reconnecter)
2. Ouvrir console navigateur ‚Üí V√©rifier absence d'erreurs
3. Ouvrir page admin sessions-actives
4. Nina doit appara√Ætre avec statut üü¢ Actif

### R√©sultat du test
‚úÖ **Test valid√©** - Nina appara√Æt correctement dans les sessions actives
‚úÖ Heartbeat fonctionne
‚úÖ Syst√®me op√©rationnel

---
