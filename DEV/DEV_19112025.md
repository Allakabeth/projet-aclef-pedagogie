# Journal de dÃ©veloppement - 19/11/2025

## [2025-11-19 16:45] - Feature: SystÃ¨me de prioritÃ© vocale pour segmentation syllabes

### Fichier(s) modifiÃ©(s)
- `pages/lire/segmentation-choix.js` - ImplÃ©mentation systÃ¨me prioritÃ© vocale

### Modifications
- **SystÃ¨me de prioritÃ© des voix** : Personnel (ma voix mes mots) â†’ ElevenLabs â†’ Web Speech
- **Chargement automatique** : Enregistrements personnels chargÃ©s au dÃ©marrage via `/api/enregistrements-mots/list`
- **Cache ElevenLabs** : Stockage localStorage pour Ã©conomiser tokens API
- **Exclusion Hortense** : SÃ©lection voix masculine (Paul, Thomas, Pierre) pour Web Speech
- **Bouton speaker amÃ©liorÃ©** : Ã‰tats ðŸ”Š (repos) / â¸ï¸ (lecture), feedback visuel semi-transparent
- **Normalisation mots** : Suppression ponctuation dÃ©but/fin, conservation apostrophes internes
- **Gestion erreurs** : Fallback automatique si Ã©chec enregistrement personnel ou ElevenLabs

### Code important

**Fonction principale de lecture audio avec prioritÃ© :**
```javascript
const playAudio = async (texte) => {
    // PRIORITÃ‰ 1 : VOIX PERSONNALISÃ‰E
    if (enregistrementsMap[motNormalise]) {
        const success = await playEnregistrement(enregistrementsMap[motNormalise])
        if (success) return
    }

    // PRIORITÃ‰ 2 : ELEVENLABS AVEC CACHE
    if (tokenStatus !== 'exhausted') {
        const response = await fetch('/api/speech/elevenlabs', {
            body: JSON.stringify({
                text: `Le mot est : ${texte}`,
                voice_id: selectedVoice
            })
        })
    }

    // PRIORITÃ‰ 3 : WEB SPEECH API (Paul/Julie, PAS Hortense)
    fallbackToWebSpeech(texte)
}
```

**Exclusion explicite voix Hortense :**
```javascript
const voices = window.speechSynthesis.getVoices()
const voixMasculine = voices.find(voice =>
    voice.lang.includes('fr') &&
    !voice.name.toLowerCase().includes('hortense') &&
    (voice.name.toLowerCase().includes('male') ||
     voice.name.toLowerCase().includes('thomas') ||
     voice.name.toLowerCase().includes('paul'))
)
```

**Chargement enregistrements personnels :**
```javascript
const loadEnregistrements = async () => {
    const response = await fetch('/api/enregistrements-mots/list', {
        headers: { 'Authorization': `Bearer ${token}` }
    })

    // Normalisation des clÃ©s
    const mapNormalise = {}
    Object.entries(data.enregistrementsMap).forEach(([mot, enreg]) => {
        const motNormalise = mot.toLowerCase().trim()
            .replace(/^[^a-zA-Z...]+/, '')  // Suppr. ponct. dÃ©but
            .replace(/[^a-zA-Z...]+$/, '')  // Suppr. ponct. fin
        mapNormalise[motNormalise] = enreg
    })
}
```

### Commit
- SHA: `4e4bec3`
- Message: "Feature: SystÃ¨me de prioritÃ© vocale pour segmentation syllabes"
- Lignes: +362 -11

---

## [2025-11-19 15:30] - UI: Refonte interface segmentation syllabes

### Fichier(s) modifiÃ©(s)
- `pages/lire/segmentation-choix.js` - Refonte complÃ¨te UX/UI segmentation

### Modifications
- **Lecture audio des syllabes** : Clic sur cartes de syllabes pour jouer l'audio enregistrÃ©
- **Curseurs dynamiques** : ðŸŽ§ si audio disponible, ðŸ”‡ si pas d'audio
- **Navigation manuelle** : Bouton â†’ apparaÃ®t aprÃ¨s validation (plus de passage automatique)
- **Design turquoise cohÃ©rent** : Titre (#06B6D4), mot (48px), syllabes (bordure + texte)
- **Optimisation affichage** : Syllabes visibles uniquement aprÃ¨s au moins 1 coupure
- **Curseurs personnalisÃ©s boutons** : ðŸ—‘ï¸ pour "sons complexes", ðŸ¤” pour "doute"
- **Simplification visuelle** : Suppression fond rouge ciseaux, suppression label "Tes morceaux"
- **AmÃ©lioration alignement** : Ciseaux alignÃ©s baseline avec lettres du mot

### Code important

**Lecture audio au clic :**
```javascript
{syllabes.map((syllabe, index) => {
    const hasAudio = currentAudioUrls[index]
    const cursorIcon = hasAudio ? 'ðŸŽ§' : 'ðŸ”‡'
    const cursorUrl = `url("data:image/svg+xml;utf8,<svg...>${cursorIcon}</text></svg>") 16 16, pointer`

    return (
        <div onClick={() => {
            if (hasAudio) {
                const audio = new Audio(currentAudioUrls[index])
                audio.play()
            }
        }}
        style={{ cursor: cursorUrl }}>
            {syllabe}
        </div>
    )
})}
```

**Bouton navigation aprÃ¨s validation :**
```javascript
{completedMots.includes(currentMot.id) && (
    <button onClick={passerMotSuivant}>
        {currentMotIndex + 1 < allMots.length ? 'â†’' : 'âœ“'}
    </button>
)}
```

**Affichage conditionnel syllabes :**
```javascript
{cuts.length > 0 && (
    // Afficher syllabes seulement aprÃ¨s coupure
)}
```

### Commit
- SHA: `e245eb3`
- Message: "UI: Refonte interface segmentation syllabes"
- Lignes: +479 -126

---
