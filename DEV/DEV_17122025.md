# Journal de dÃ©veloppement - 17/12/2025

## [2025-12-17 ~10:00] - Feature: Enregistrements personnels dans jeu 5 (Syllabe mystÃ¨re)

### Fichier(s) modifiÃ©(s)
- `pages/lire/syllabes-jeu-5.js` - Utilisation des enregistrements audio personnels

### Contexte
Dans le jeu "Syllabe mystÃ¨re", le son jouÃ© Ã©tait toujours la synthÃ¨se vocale. L'utilisateur souhaite que les syllabes jouent les enregistrements personnels faits dans la rÃ©colte des syllabes, avec fallback sur la voix de synthÃ¨se si pas d'enregistrement.

### Modifications
- Ajout state `syllabesAudio` pour stocker le dictionnaire syllabe â†’ URL audio
- CrÃ©ation fonction `jouerSyllabe()` avec fallback sur `lireTexte()`
- Chargement des enregistrements via `/api/enregistrements-syllabes/list`
- Remplacement des appels `lireTexte()` par `jouerSyllabe()` :
  - Dans `startNewRound()` (lecture automatique)
  - Dans le bouton "Ã‰couter"

### Code important
```javascript
const [syllabesAudio, setSyllabesAudio] = useState({})

// Fonction pour jouer une syllabe (enregistrement perso si dispo, sinon fallback)
const jouerSyllabe = (syllabe) => {
    if (!syllabe) return
    const syllabeNormalisee = syllabe.toLowerCase().trim()
    const audioUrl = syllabesAudio[syllabeNormalisee]

    if (audioUrl) {
        console.log(`ðŸŽµ Lecture enregistrement perso pour "${syllabe}"`)
        const audio = new Audio(audioUrl)
        audio.play().catch(err => {
            console.error('Erreur lecture audio:', err)
            lireTexte(syllabe)
        })
    } else {
        console.log(`âš ï¸ Pas d'enregistrement pour "${syllabe}", fallback voix`)
        lireTexte(syllabe)
    }
}

// Chargement des enregistrements dans loadUserWords
const responseAudio = await fetch('/api/enregistrements-syllabes/list', {
    headers: { 'Authorization': `Bearer ${token}` }
})
if (responseAudio.ok) {
    const dataAudio = await responseAudio.json()
    const audioMap = {}
    Object.values(dataAudio.segmentationsMap || {}).forEach(seg => {
        if (seg.segmentation_personnalisee && seg.audio_urls) {
            seg.segmentation_personnalisee.forEach((syllabe, index) => {
                if (seg.audio_urls[index]) {
                    const syllabeNorm = syllabe.toLowerCase().trim()
                    if (!audioMap[syllabeNorm]) {
                        audioMap[syllabeNorm] = seg.audio_urls[index]
                    }
                }
            })
        }
    })
    setSyllabesAudio(audioMap)
}
```

### Commit
- En attente de commit

---

## [2025-12-17 ~09:30] - Feature: Bouton toggle voix automatique dans jeu 8

### Fichier(s) modifiÃ©(s)
- `pages/lire/syllabes-jeu-8.js` - Ajout bouton toggle voix automatique

### Contexte
Dans le jeu "Compter les syllabes", la voix automatique lit le mot Ã  chaque tour. L'utilisateur souhaite pouvoir dÃ©sactiver cette fonctionnalitÃ© tout en gardant le bouton "Ã‰couter" disponible.

### Modifications
- Ajout state `voixAuto` (true par dÃ©faut)
- Lecture automatique conditionnÃ©e par `voixAuto`
- Bouton toggle Ã  gauche dans la barre de progression :
  - ðŸ”Š Vert = voix auto activÃ©e
  - ðŸ”‡ Gris = voix auto dÃ©sactivÃ©e
- Bouton "Ã‰couter" reste disponible dans tous les cas

### Code important
```javascript
const [voixAuto, setVoixAuto] = useState(true)

// Lecture conditionnelle
setTimeout(() => {
    if (voixAuto) {
        lireTexte(word.original)
    }
}, 500)

// Bouton toggle
<button onClick={() => setVoixAuto(!voixAuto)}>
    {voixAuto ? 'ðŸ”Š Auto' : 'ðŸ”‡ Auto'}
</button>
```

### Commit
- SHA: `d75aa51`
- Message: "Feature: Bouton toggle voix automatique dans jeu 8 (Compter syllabes)"
- Lignes: +22 -2

---

## [2025-12-17 ~09:00] - Fix: Exclusion sons complexes + cadres adaptatifs rÃ©colte syllabes

### Fichier(s) modifiÃ©(s)
- `pages/api/mots-classifies/multisyllabes-simple.js` - Exclusion des mots sons complexes
- `pages/lire/recolte-syllabes.js` - Cadres adaptatifs pour mots longs + anti-doublons paniers

### Contexte
ProblÃ¨me signalÃ© : le mot "action" apparaissait dans la rÃ©colte de syllabes de Nokya alors qu'elle l'avait rangÃ© dans les sons complexes. Cause : l'API ne vÃ©rifiait pas la table `mots_sons_complexes`.

ProblÃ¨me 2 : les mots longs Ã©taient tronquÃ©s dans les cadres (maxWidth fixe).

### Modifications

**API multisyllabes-simple.js :**
- Ajout requÃªte pour rÃ©cupÃ©rer `mots_sons_complexes` de l'apprenant
- CrÃ©ation d'un Set des mots Ã  exclure (normalisÃ©s en minuscules)
- Filtre `.filter()` pour exclure ces mots des rÃ©sultats multisyllabes

**recolte-syllabes.js :**
- Suppression `maxWidth: '120px'` sur cadre mot complet
- Suppression `maxWidth: '80px'` sur syllabes segmentÃ©es
- Suppression `maxWidth: '100px'` sur syllabe Ã  classer
- Suppression `overflow: hidden` et `textOverflow: ellipsis` associÃ©s
- Les cadres s'adaptent maintenant Ã  la longueur du contenu

### Code important
```javascript
// API - Exclusion des sons complexes
const { data: sonsComplexesData } = await supabase
    .from('mots_sons_complexes')
    .select('mot_normalise')
    .eq('apprenant_id', decoded.id)

const motsSonsComplexes = new Set(
    (sonsComplexesData || []).map(m => m.mot_normalise?.toLowerCase())
)

const motsUniques = [...new Set(multisyllabesData?.map(m => m.mot) || [])]
    .filter(mot => !motsSonsComplexes.has(mot.toLowerCase()))
    .sort()
```

### Commit
- SHA: `72a8f2c`
- Message: "Fix: Exclusion sons complexes + cadres adaptatifs rÃ©colte syllabes"
- Lignes: +36 -21

---

*En attente de tÃ¢ches Ã  rÃ©aliser...*
