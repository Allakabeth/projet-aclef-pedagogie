# Journal de dÃ©veloppement - 17/11/2025

## [2025-11-17 23:00] - UI: Refonte complÃ¨te exercice Qu'est-ce que c'est (Mes Syllabes-Mots)

### Fichier(s) modifiÃ©(s)
- `components/exercices-syllabes-mots/ExerciceQuestCe.js` - Refonte UI et cascade de voix

### Modifications

**Objectif :** Aligner l'exercice "Qu'est-ce que c'est" sur le design de "OÃ¹ est-ce" avec cascade de voix prioritaire.

**Changements UI :**
1. **Titre bleu (#3b82f6)** au lieu du dÃ©gradÃ© violet
2. **Navigation icÃ´nes** : Ajout de 4 icÃ´nes (â†, ğŸ‘ï¸, ğŸ“–, ğŸ ) entre titre et instructions
3. **Suppression cadre "ğŸ¤ Choisissez une voix"** (lignes 311-351 supprimÃ©es)
4. **Suppression cadre score** (lignes 353-367 supprimÃ©es)
5. **Suppression cadres jaune/blanc** autour du mot affichÃ© - mot directement en 48px bleu
6. **Structure boutons identique Ã  /lire/quest-ce.js** :
   - NumÃ©ro centrÃ© en haut de chaque carte
   - Deux boutons cÃ´te Ã  cÃ´te avec `flex: 1`
   - Bouton ğŸ”Š bleu Ã  gauche (devient orange â¸ï¸ pendant lecture)
   - Bouton âœ“ avec bordure bleue Ã  droite (transparent, devient bleu au hover)

**Cascade de voix implÃ©mentÃ©e (prioritÃ©) :**
```javascript
// PRIORITÃ‰ 1 : Enregistrement personnel
if (map[motNormalise]) {
    const audio = new Audio(map[motNormalise].audio_url)
    await audio.play()
    return
}

// PRIORITÃ‰ 2 : ElevenLabs (si tokens > 0)
if (elevenLabsTokens > 0) {
    const response = await fetch('/api/speech/elevenlabs', {
        body: JSON.stringify({
            text: text,
            voice_id: 'tMyQcCxfGDdIt7wJ2RQw' // Julie
        })
    })
    // Recharger tokens aprÃ¨s utilisation
    loadElevenLabsTokens()
    return
}

// PRIORITÃ‰ 3 : Web Speech API (sans Hortense)
const frenchVoices = voices.filter(v =>
    v.lang.startsWith('fr') &&
    !v.name.toLowerCase().includes('hortense')
)
const preferredVoice = frenchVoices.find(v =>
    v.name.toLowerCase().includes('julie') ||
    v.name.toLowerCase().includes('thomas') ||
    v.name.toLowerCase().includes('daniel')
) || frenchVoices[0]
```

**Fonctions ajoutÃ©es :**
- `loadEnregistrements()` - Charge enregistrements personnels au dÃ©marrage
- `loadElevenLabsTokens()` - Charge tokens ElevenLabs disponibles
- `playWebSpeech()` - Fallback Web Speech API avec sÃ©lection voix intelligente
- `enregistrementsMapRef` - useRef pour accÃ¨s synchrone aux enregistrements

**Normalisation des mots (matching) :**
```javascript
const motNormalise = text
    .toLowerCase()
    .trim()
    .replace(/^[.,;:!?Â¡Â¿'"Â«Â»\-â€”]+/, '') // Supprimer ponctuation dÃ©but
    .replace(/[.,;:!?Â¡Â¿'"Â«Â»\-â€”]+$/, '') // Supprimer ponctuation fin
```

### Code important

**Structure boutons (lignes 532-623) :**
```javascript
<div style={{
    display: 'grid',
    gridTemplateColumns: window.innerWidth <= 768 ?
        (displayedMots.length <= 4 ? 'repeat(2, 1fr)' : 'repeat(3, 1fr)') :
        'repeat(auto-fit, minmax(250px, 1fr))',
    gap: window.innerWidth <= 768 ? '6px' : '20px'
}}>
    {displayedMots.map((mot, index) => (
        <div style={{ border: '2px solid #dee2e6', borderRadius: '8px', padding: '15px' }}>
            {/* NumÃ©ro */}
            <span>{index + 1}</span>

            {/* Boutons cÃ´te Ã  cÃ´te */}
            <div style={{ display: 'flex', gap: '10px' }}>
                <button style={{ flex: 1, backgroundColor: '#3b82f6' }}>
                    {isPlaying === mot.id ? 'â¸ï¸' : 'ğŸ”Š'}
                </button>
                <button style={{ flex: 1, border: '2px solid #3b82f6', backgroundColor: 'transparent' }}>
                    âœ“
                </button>
            </div>
        </div>
    ))}
</div>
```

### Avantages UX

âœ… **CohÃ©rence interface** : MÃªme design que "OÃ¹ est-ce" (ExerciceOuEst.js)
âœ… **Navigation simplifiÃ©e** : 4 icÃ´nes claires au lieu d'un bouton texte
âœ… **Cascade de voix intelligente** : PrioritÃ© enregistrements perso â†’ IA â†’ synthÃ¨se
âœ… **Interface Ã©purÃ©e** : Suppression Ã©lÃ©ments superflus (sÃ©lecteur voix, score)
âœ… **Boutons identiques Ã  /lire/quest-ce.js** : FamiliaritÃ© pour l'apprenant

### Commit
- SHA: `cceca19`
- Message: "UI: Refonte complÃ¨te exercice Qu'est-ce que c'est (Mes Syllabes-Mots)"
- Lignes: +332 -180

---

## [2025-11-17 22:15] - UI: Fix affichage cartes exercices desktop/mobile Mes Syllabes-Mots

### Fichier(s) modifiÃ©(s)
- `pages/lire/mes-syllabes-mots-new.js` - Restauration cartes exercices avec visibilitÃ© desktop uniquement

### Modifications

**ProblÃ¨me :** Les 3 cartes d'exercices en bas de page avaient Ã©tÃ© supprimÃ©es complÃ¨tement au lieu d'Ãªtre masquÃ©es uniquement sur mobile.

**Solution :**
- Restauration des 3 cartes d'exercices (Classement ğŸ·ï¸, OÃ¹ est-ce ğŸ”, Qu'est-ce ğŸ¤”)
- Ajout `className="desktop-only"` sur le conteneur des cartes
- Sur desktop : cartes visibles avec design complet
- Sur mobile : cartes masquÃ©es, icÃ´nes de navigation compactes visibles

**Cartes restaurÃ©es (lignes 459-647) :**
```javascript
{/* Cartes exercices - Desktop uniquement */}
<div className="desktop-only" style={{
    maxWidth: '940px',
    margin: '0 auto',
    marginTop: '40px'
}}>
    <h2>ğŸ® Choisissez votre exercice</h2>

    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '20px' }}>
        {/* Carte 1: Classement (bordure rouge #ef4444) */}
        {/* Carte 2: OÃ¹ est ce mot ? (bordure verte #10b981) */}
        {/* Carte 3: Qu'est-ce que c'est ? (bordure bleue #3b82f6) */}
    </div>
</div>
```

### Comportement final

**Desktop (> 768px) :**
- âœ… 3 cartes d'exercices visibles en bas
- âœ… Design complet avec descriptions et boutons "ğŸš€ Commencer"
- âœ… IcÃ´nes de navigation en haut (ğŸ“–, ğŸ )

**Mobile (â‰¤ 768px) :**
- âœ… Cartes d'exercices masquÃ©es
- âœ… IcÃ´nes de navigation compactes (ğŸ“–, ğŸ , ğŸ·ï¸, ğŸ”, ğŸ¤”)
- âœ… Titre "ğŸ¯ Choisissez vos textes" masquÃ©

### Commit
- SHA: `9e0e92e`
- Message: "UI: Fix affichage cartes exercices desktop/mobile Mes Syllabes-Mots"
- Lignes: +616 -446

---

## [2025-11-17 21:45] - UX: AmÃ©lioration feedback chargement Construis Phrases

### Fichier(s) modifiÃ©(s)
- `pages/lire/reconnaitre-les-mots/construis-phrases-tranquille.js` - Ajout indicateurs progression
- `pages/lire/reconnaitre-les-mots/construis-phrases-difficile.js` - Ajout indicateurs progression
- `pages/lire/reconnaitre-les-mots/construis-phrases-defi.js` - Ajout indicateurs progression

### Modifications

**ProblÃ¨me initial :** Interface bloquÃ©e sur "Chargement..." sans retour visuel. L'utilisateur ne sait pas si Ã§a marche ou si c'est plantÃ©.

**Solution implÃ©mentÃ©e :**

1. **Ajout Ã©tats de suivi (tous les modes) :**
```javascript
const [loadingStep, setLoadingStep] = useState('') // Ã‰tape en cours
const [loadingTimeout, setLoadingTimeout] = useState(false) // Timeout dÃ©passÃ©
```

2. **Timeout sÃ©curitÃ© 30s dans `checkAuth()` :**
```javascript
const timeoutId = setTimeout(() => {
    setLoadingTimeout(true)
    console.warn('â±ï¸ Timeout chargement dÃ©passÃ© (30s)')
}, 30000)

try {
    setLoadingStep('Chargement des phrases...')
    await chargerPhrases(router.query.texte_ids)

    setLoadingStep('Chargement des enregistrements...') // Tranquille uniquement
    await loadEnregistrements()

    clearTimeout(timeoutId)
    setLoadingStep('')
} catch (err) {
    clearTimeout(timeoutId)
    setLoadingError('Erreur lors du chargement. Veuillez rÃ©essayer.')
}
```

3. **Interface de chargement amÃ©liorÃ©e :**
   - â³ IcÃ´ne qui tourne (animation CSS)
   - Message d'Ã©tape dynamique
   - Texte explicatif
   - Si timeout > 30s : bouton "RÃ©essayer" + "Retour menu"

### Code important

**Rendu conditionnel du chargement :**
```javascript
if (etape === 'chargement' || !phraseActuelle) {
    return (
        <div style={{...}}>
            {!loadingTimeout ? (
                // Chargement normal : icÃ´ne + message Ã©tape
                <>
                    <div style={{ animation: 'spin 2s linear infinite' }}>â³</div>
                    <div>{loadingStep || 'Chargement...'}</div>
                </>
            ) : (
                // Timeout : message + boutons action
                <>
                    <div>â±ï¸</div>
                    <div>Le chargement prend plus de temps que prÃ©vu...</div>
                    <button onClick={() => window.location.reload()}>
                        ğŸ”„ RÃ©essayer
                    </button>
                    <button onClick={() => router.push('/menu')}>
                        â† Retour au menu
                    </button>
                </>
            )}
        </div>
    )
}
```

### Messages affichÃ©s par ordre :

**Mode Tranquille :**
1. "Chargement des phrases..."
2. "Chargement des enregistrements..."

**Mode Difficile :**
1. "Chargement des phrases..."

**Mode DÃ©fi :**
1. "Chargement des enregistrements..."
2. "Chargement des phrases..."

### Avantages UX

âœ… L'utilisateur sait que Ã§a charge (icÃ´ne animÃ©e)
âœ… L'utilisateur sait QUOI charge (message d'Ã©tape)
âœ… Si blocage > 30s : option rÃ©essayer sans revenir en arriÃ¨re
âœ… Option retour menu si vraiment bloquÃ©
âœ… Console logs conservÃ©s pour debug

### DÃ©cisions architecturales

1. **Timeout 30s au lieu de 10s** : GÃ©nÃ©ration phrases peut prendre du temps sur Vercel (appel OpenRouter IA)
2. **Animation CSS inline** : Ã‰vite dÃ©pendance externe, fonctionne partout
3. **window.location.reload()** : Reset complet plus fiable que state reset
4. **CohÃ©rence visuelle** : MÃªme structure pour les 3 modes (seules couleurs changent)

### Contexte

Suite au redÃ©ploiement Vercel avec variables environnement, la gÃ©nÃ©ration de phrases fonctionne mais l'interface restait bloquÃ©e sans feedback. Frustrant pour l'utilisateur qui ne savait pas si :
- Ã‡a charge encore
- C'est plantÃ©
- Il doit revenir en arriÃ¨re

Cette amÃ©lioration rend le chargement transparent et donne le contrÃ´le Ã  l'utilisateur.

### Commit

- SHA: `6bbbc1b`
- Message: "UX: AmÃ©lioration feedback chargement Construis Phrases"
- Lignes: +537 -11

---

## [20:30] - UI: Ajout icÃ´nes navigation + Fix: GÃ©nÃ©ration phrases Vercel

### Fichiers modifiÃ©s
- `pages/lire/ou-est-ce-exercice.js` - Ajout section navigation sur page rÃ©sultats
- `.mcp.json` - Ajout serveur MCP Vercel
- Variables d'environnement Vercel (import depuis `.env.local`)

### ProblÃ¨me identifiÃ© : GÃ©nÃ©ration phrases Ã©choue sur Vercel (503)

**SymptÃ´mes :**
- âœ… Fonctionne en localhost
- âŒ Erreur 503 sur Vercel en 760ms (trop rapide pour Ãªtre un timeout)
- Console : `Error: An unexpected error occurred`

**Diagnostic :**
1. **760ms = trop rapide pour timeout Vercel** (limite 10s)
2. **Erreur survient AVANT appel OpenRouter IA**
3. **Cause probable : Variables d'environnement manquantes**

**Variables critiques pour `/api/phrases/generer` :**
```bash
OPENROUTER_API_KEY          # Appel IA pour gÃ©nÃ©ration phrases
GOOGLE_AI_API_KEY_NEW       # Fallback Gemini
SUPABASE_SERVICE_ROLE_KEY   # AccÃ¨s BDD pour cache/stockage
NEXT_PUBLIC_SUPABASE_URL    # URL Supabase
```

**Solution appliquÃ©e :**
1. Import `.env.local` dans Vercel (Settings â†’ Environment Variables)
2. Commit vide pour forcer redÃ©ploiement : `a493138`
3. Attendre que build Vercel soit terminÃ©

### Modifications - Navigation page rÃ©sultats "OÃ¹ est-ce"

**ProblÃ¨me :** Page rÃ©sultats de l'exercice "OÃ¹ est-ce" n'avait pas les icÃ´nes de navigation

**Solution (lignes 1081-1176 de `ou-est-ce-exercice.js`) :**
```javascript
{/* Boutons de navigation */}
<div style={{
    display: 'flex',
    gap: isMobile ? '8px' : '12px',
    justifyContent: 'center',
    width: '100%',
    maxWidth: '1200px',
    marginBottom: isMobile ? '12px' : '24px'
}}>
    {/* 5 boutons : â†, ğŸ‘ï¸, ğŸ“–, ğŸ , ğŸ” */}
    <button onClick={() => {
        const ids = router.query.texte_ids ? router.query.texte_ids.split(',').map(id => parseInt(id)) : []
        if (ids.length > 0) {
            chargerGroupesSens(ids)
        }
    }} title="Recommencer">
        ğŸ”
    </button>
</div>
```

**FonctionnalitÃ©s ajoutÃ©es :**
- **â† (flÃ¨che)** : Retour menu exercices (`/lire/reconnaitre-les-mots/exercices2?textes=1`)
- **ğŸ‘ï¸ (Å“il)** : SÃ©lection textes (`/lire/reconnaitre-les-mots`)
- **ğŸ“– (livre)** : Menu Lire (`/lire`)
- **ğŸ  (maison)** : Dashboard (`/dashboard`)
- **ğŸ” (recommencer)** : Relance exercice avec mÃªmes textes via `router.query.texte_ids`

**Style :** Responsive mobile/desktop cohÃ©rent avec page exercice

### MCP Vercel - Configuration

**Ajout serveur MCP dans `.mcp.json` :**
```json
"vercel": {
  "command": "npx",
  "args": ["-y", "@vercel/mcp-server-vercel"],
  "env": {
    "VERCEL_TOKEN": "mCWsPwNEjVy4nPPIz0kIh01q"
  }
}
```

**Activation :** RedÃ©marrage Claude Code requis

**UtilitÃ© :**
- AccÃ¨s logs Vercel dÃ©taillÃ©s
- Gestion dÃ©ploiements
- Debug production

### Architecture API `/api/phrases/generer`

**Flow de gÃ©nÃ©ration (rappel technique) :**

1. **VÃ©rification auth** (JWT token)
2. **Recherche cache BDD** (`phrases_pregenerees` table)
   - Si existe â†’ retour immÃ©diat (mÃ©lange Fisher-Yates + sÃ©lection 10 phrases)
3. **Si pas de cache â†’ GÃ©nÃ©ration IA :**
   - RÃ©cupÃ©ration groupes_sens pour extraire mots uniques
   - Appel OpenRouter (Gemini 2.0 Flash Exp Free) avec retry 5x si rate-limit
   - Filtrage phrases identiques aux textes originaux (normalisation ultra-stricte)
   - Stockage en BDD pour cache futur
   - Retour 10 phrases mÃ©langÃ©es

**Normalisation ultra-stricte (Ã©viter doublons avec texte original) :**
```javascript
const phraseNorm = phrase
    .toLowerCase()
    .normalize("NFD")                        // DÃ©composer accents
    .replace(/[\u0300-\u036f]/g, "")         // Supprimer accents
    .replace(/[.,;:!?Â¡Â¿'\"Â«Â»\-â€”()]/g, '')    // Supprimer ponctuation
    .replace(/\s+/g, ' ')                    // Normaliser espaces
    .trim()
```

**Gestion erreurs retournÃ©es :**
- `QUOTA_EXCEEDED` â†’ 503 avec message quota dÃ©passÃ©
- `NO_PHRASES_GENERATED` â†’ 503 retry Ã©chouÃ©s
- Autres â†’ 500 erreur gÃ©nÃ©rique

### Code important - Bouton Recommencer

**Pattern rÃ©cupÃ©ration paramÃ¨tres URL pour relance exercice :**
```javascript
onClick={() => {
    // RÃ©cupÃ©rer texte_ids depuis l'URL
    const ids = router.query.texte_ids
        ? router.query.texte_ids.split(',').map(id => parseInt(id))
        : []

    if (ids.length > 0) {
        chargerGroupesSens(ids)  // Relancer avec mÃªmes donnÃ©es
    }
}}
```

**UtilitÃ© :** Permettre Ã  l'apprenant de recommencer immÃ©diatement sans revenir au menu de sÃ©lection

### DÃ©cisions architecturales

1. **Variables Vercel importÃ©es depuis `.env.local`** au lieu de saisie manuelle
   - Raison : CohÃ©rence local/prod
   - Avantage : Mise Ã  jour centralisÃ©e

2. **Serveur MCP Vercel ajoutÃ© pour debug futur**
   - Permet diagnostic rapide erreurs production
   - AccÃ¨s logs sans passer par dashboard web

3. **Navigation rÃ©sultats identique Ã  page exercice**
   - CohÃ©rence UX
   - Moins de confusion pour apprenants

### PiÃ¨ges Ã©vitÃ©s

1. **Erreur 503 â‰  Timeout si < 1s**
   - 760ms = trop rapide pour timeout Vercel (10s)
   - Diagnostic : chercher variables manquantes AVANT de blÃ¢mer le code

2. **Variables Vercel pas automatiquement appliquÃ©es**
   - Import variables â‰  redÃ©ploiement automatique
   - Solution : commit vide force rebuild

3. **Token Vercel CLI expirÃ©**
   - Les tokens d'accÃ¨s ont une durÃ©e de vie limitÃ©e
   - Fallback : utiliser dashboard web si CLI Ã©choue

### Contexte

**Pourquoi ces changements :**
1. Apprenant bloquÃ© sur page rÃ©sultats sans navigation â†’ Frustration UX
2. GÃ©nÃ©ration phrases fonctionne en local mais pas en prod â†’ Variables manquantes
3. Debug difficile sans accÃ¨s logs Vercel â†’ MCP installÃ©

**Impact utilisateur :**
- âœ… Navigation fluide page rÃ©sultats
- âœ… Bouton recommencer Ã©vite retour menu (gain de temps)
- â³ GÃ©nÃ©ration phrases Vercel en attente redÃ©ploiement

### Prochaines Ã©tapes

1. **VÃ©rifier build Vercel terminÃ©** (commit `a493138`)
2. **Tester gÃ©nÃ©ration phrases en production**
3. **Si Ã©chec persiste :** Activer MCP Vercel (redÃ©marrer Claude Code) pour logs dÃ©taillÃ©s
4. **AmÃ©liorer messages d'erreur cÃ´tÃ© client** (pages construis-phrases) pour afficher dÃ©tails API

### Commits

- **950b5ac** : UI: Ajout icÃ´nes navigation sur page rÃ©sultats OÃ¹ est-ce (+97 lignes)
- **a493138** : chore: RedÃ©ploiement aprÃ¨s ajout variables environnement (commit vide)

### Temps session : ~30 min
