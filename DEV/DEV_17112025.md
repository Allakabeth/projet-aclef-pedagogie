# Journal de dÃ©veloppement - 17/11/2025

## [20:30] - UI: Ajout icÃ´nes navigation + Fix: GÃ©nÃ©ration phrases Vercel

### Fichiers modifiÃ©s
- `pages/lire/ou-est-ce-exercice.js` - Ajout section navigation sur page rÃ©sultats
- `.mcp.json` - Ajout serveur MCP Vercel
- Variables d'environnement Vercel (import depuis `.env.local`)

### ProblÃ¨me identifiÃ© : GÃ©nÃ©ration phrases Ã©choue sur Vercel (503)

**SymptÃ´mes :**
- âœ… Fonctionne en localhost
- âŒ Erreur 503 sur Vercel en 760ms (trop rapide pour Ãªtre un timeout)
- Console : `Error: An unexpected error occurred`

**Diagnostic :**
1. **760ms = trop rapide pour timeout Vercel** (limite 10s)
2. **Erreur survient AVANT appel OpenRouter IA**
3. **Cause probable : Variables d'environnement manquantes**

**Variables critiques pour `/api/phrases/generer` :**
```bash
OPENROUTER_API_KEY          # Appel IA pour gÃ©nÃ©ration phrases
GOOGLE_AI_API_KEY_NEW       # Fallback Gemini
SUPABASE_SERVICE_ROLE_KEY   # AccÃ¨s BDD pour cache/stockage
NEXT_PUBLIC_SUPABASE_URL    # URL Supabase
```

**Solution appliquÃ©e :**
1. Import `.env.local` dans Vercel (Settings â†’ Environment Variables)
2. Commit vide pour forcer redÃ©ploiement : `a493138`
3. Attendre que build Vercel soit terminÃ©

### Modifications - Navigation page rÃ©sultats "OÃ¹ est-ce"

**ProblÃ¨me :** Page rÃ©sultats de l'exercice "OÃ¹ est-ce" n'avait pas les icÃ´nes de navigation

**Solution (lignes 1081-1176 de `ou-est-ce-exercice.js`) :**
```javascript
{/* Boutons de navigation */}
<div style={{
    display: 'flex',
    gap: isMobile ? '8px' : '12px',
    justifyContent: 'center',
    width: '100%',
    maxWidth: '1200px',
    marginBottom: isMobile ? '12px' : '24px'
}}>
    {/* 5 boutons : â†, ğŸ‘ï¸, ğŸ“–, ğŸ , ğŸ” */}
    <button onClick={() => {
        const ids = router.query.texte_ids ? router.query.texte_ids.split(',').map(id => parseInt(id)) : []
        if (ids.length > 0) {
            chargerGroupesSens(ids)
        }
    }} title="Recommencer">
        ğŸ”
    </button>
</div>
```

**FonctionnalitÃ©s ajoutÃ©es :**
- **â† (flÃ¨che)** : Retour menu exercices (`/lire/reconnaitre-les-mots/exercices2?textes=1`)
- **ğŸ‘ï¸ (Å“il)** : SÃ©lection textes (`/lire/reconnaitre-les-mots`)
- **ğŸ“– (livre)** : Menu Lire (`/lire`)
- **ğŸ  (maison)** : Dashboard (`/dashboard`)
- **ğŸ” (recommencer)** : Relance exercice avec mÃªmes textes via `router.query.texte_ids`

**Style :** Responsive mobile/desktop cohÃ©rent avec page exercice

### MCP Vercel - Configuration

**Ajout serveur MCP dans `.mcp.json` :**
```json
"vercel": {
  "command": "npx",
  "args": ["-y", "@vercel/mcp-server-vercel"],
  "env": {
    "VERCEL_TOKEN": "mCWsPwNEjVy4nPPIz0kIh01q"
  }
}
```

**Activation :** RedÃ©marrage Claude Code requis

**UtilitÃ© :**
- AccÃ¨s logs Vercel dÃ©taillÃ©s
- Gestion dÃ©ploiements
- Debug production

### Architecture API `/api/phrases/generer`

**Flow de gÃ©nÃ©ration (rappel technique) :**

1. **VÃ©rification auth** (JWT token)
2. **Recherche cache BDD** (`phrases_pregenerees` table)
   - Si existe â†’ retour immÃ©diat (mÃ©lange Fisher-Yates + sÃ©lection 10 phrases)
3. **Si pas de cache â†’ GÃ©nÃ©ration IA :**
   - RÃ©cupÃ©ration groupes_sens pour extraire mots uniques
   - Appel OpenRouter (Gemini 2.0 Flash Exp Free) avec retry 5x si rate-limit
   - Filtrage phrases identiques aux textes originaux (normalisation ultra-stricte)
   - Stockage en BDD pour cache futur
   - Retour 10 phrases mÃ©langÃ©es

**Normalisation ultra-stricte (Ã©viter doublons avec texte original) :**
```javascript
const phraseNorm = phrase
    .toLowerCase()
    .normalize("NFD")                        // DÃ©composer accents
    .replace(/[\u0300-\u036f]/g, "")         // Supprimer accents
    .replace(/[.,;:!?Â¡Â¿'\"Â«Â»\-â€”()]/g, '')    // Supprimer ponctuation
    .replace(/\s+/g, ' ')                    // Normaliser espaces
    .trim()
```

**Gestion erreurs retournÃ©es :**
- `QUOTA_EXCEEDED` â†’ 503 avec message quota dÃ©passÃ©
- `NO_PHRASES_GENERATED` â†’ 503 retry Ã©chouÃ©s
- Autres â†’ 500 erreur gÃ©nÃ©rique

### Code important - Bouton Recommencer

**Pattern rÃ©cupÃ©ration paramÃ¨tres URL pour relance exercice :**
```javascript
onClick={() => {
    // RÃ©cupÃ©rer texte_ids depuis l'URL
    const ids = router.query.texte_ids
        ? router.query.texte_ids.split(',').map(id => parseInt(id))
        : []

    if (ids.length > 0) {
        chargerGroupesSens(ids)  // Relancer avec mÃªmes donnÃ©es
    }
}}
```

**UtilitÃ© :** Permettre Ã  l'apprenant de recommencer immÃ©diatement sans revenir au menu de sÃ©lection

### DÃ©cisions architecturales

1. **Variables Vercel importÃ©es depuis `.env.local`** au lieu de saisie manuelle
   - Raison : CohÃ©rence local/prod
   - Avantage : Mise Ã  jour centralisÃ©e

2. **Serveur MCP Vercel ajoutÃ© pour debug futur**
   - Permet diagnostic rapide erreurs production
   - AccÃ¨s logs sans passer par dashboard web

3. **Navigation rÃ©sultats identique Ã  page exercice**
   - CohÃ©rence UX
   - Moins de confusion pour apprenants

### PiÃ¨ges Ã©vitÃ©s

1. **Erreur 503 â‰  Timeout si < 1s**
   - 760ms = trop rapide pour timeout Vercel (10s)
   - Diagnostic : chercher variables manquantes AVANT de blÃ¢mer le code

2. **Variables Vercel pas automatiquement appliquÃ©es**
   - Import variables â‰  redÃ©ploiement automatique
   - Solution : commit vide force rebuild

3. **Token Vercel CLI expirÃ©**
   - Les tokens d'accÃ¨s ont une durÃ©e de vie limitÃ©e
   - Fallback : utiliser dashboard web si CLI Ã©choue

### Contexte

**Pourquoi ces changements :**
1. Apprenant bloquÃ© sur page rÃ©sultats sans navigation â†’ Frustration UX
2. GÃ©nÃ©ration phrases fonctionne en local mais pas en prod â†’ Variables manquantes
3. Debug difficile sans accÃ¨s logs Vercel â†’ MCP installÃ©

**Impact utilisateur :**
- âœ… Navigation fluide page rÃ©sultats
- âœ… Bouton recommencer Ã©vite retour menu (gain de temps)
- â³ GÃ©nÃ©ration phrases Vercel en attente redÃ©ploiement

### Prochaines Ã©tapes

1. **VÃ©rifier build Vercel terminÃ©** (commit `a493138`)
2. **Tester gÃ©nÃ©ration phrases en production**
3. **Si Ã©chec persiste :** Activer MCP Vercel (redÃ©marrer Claude Code) pour logs dÃ©taillÃ©s
4. **AmÃ©liorer messages d'erreur cÃ´tÃ© client** (pages construis-phrases) pour afficher dÃ©tails API

### Commits

- **950b5ac** : UI: Ajout icÃ´nes navigation sur page rÃ©sultats OÃ¹ est-ce (+97 lignes)
- **a493138** : chore: RedÃ©ploiement aprÃ¨s ajout variables environnement (commit vide)

### Temps session : ~30 min
