# Journal de DÃ©veloppement - 13/11/2025

---

## [2025-11-13 03:15] - ğŸ’¾ SAUVEGARDE: Migration pattern moderne - Ã‰coute et trouve + Lis et trouve

âš ï¸ **Sauvegarde avant compactage de conversation (38% tokens restants)**

### Contexte
Session intensive de migration de 2 exercices vers le pattern moderne validÃ©. Conversation longue avec beaucoup de modifications successives.

### Fichiers modifiÃ©s

**1. `/lire/ecoute-et-trouve.js` - TERMINÃ‰ âœ…**
- Migration complÃ¨te vers pattern moderne
- Corrections cascade audio + double lecture
- Page intro rÃ©tablie avec slider 4-12 mots

**2. `/lire/lis-et-trouve.js` - TERMINÃ‰ âœ…**
- Migration complÃ¨te vers pattern moderne (3 pages sÃ©parÃ©es)
- Normalisation enregistrementsMap
- Auto-chargement via texte_ids

**3. `/lire/reconnaitre-les-mots/exercices2.js`**
- Carte #7 "Ã‰coute et trouve" activÃ©e
- Carte #8 "Lis et trouve" activÃ©e

### Travail terminÃ©

**Ã‰coute et trouve (exercice #7) :**
- âœ… Suppression double lecture audio (ligne 342 dans demarrerExercice)
- âœ… RÃ©tablissement page intro avec slider 4-12 mots
- âœ… Normalisation clÃ©s enregistrementsMap pour cascade audio
- âœ… Pattern moderne : etape (chargement/intro/exercice/resultats)
- âœ… Auto-chargement mots via router.query.texte_ids
- âœ… router.isReady pour Ã©viter double chargement
- âœ… Suppression score en double (desktop)
- âœ… Suppression 3 boutons desktop (Ã‰couter, ArrÃªter, Retour)

**Lis et trouve (exercice #8) :**
- âœ… Migration 3 pages sÃ©parÃ©es (intro â†’ exercice â†’ rÃ©sultats)
- âœ… Ã‰tat etape ajoutÃ© (chargement/intro/exercice/resultats)
- âœ… Auto-chargement mots dans checkAuth()
- âœ… Normalisation enregistrementsMap (mÃªme fix que Ã©coute-et-trouve)
- âœ… Modification startGame() pour utiliser allMots dÃ©jÃ  chargÃ©
- âœ… Condition JSX : etape === 'intro' / 'exercice' / 'resultats'
- âœ… router.isReady ajoutÃ©
- âœ… Confettis sur etape === 'resultats'
- âœ… Carte #8 activÃ©e dans exercices2.js

### Points clÃ©s Ã  retenir

**Pattern moderne (5 piliers) :**
1. **Auto-dÃ©marrage** - router.query.texte_ids â†’ charger mots â†’ afficher intro
2. **Navigation moderne** - IcÃ´nes entre titre et score (â† ğŸ‘ï¸ ğŸ“– ğŸ  ğŸ”Š)
3. **Audio cascade** - Voix perso > ElevenLabs > Web Speech (pas Hortense)
4. **Interface Ã©purÃ©e** - Pas de cadres blancs inutiles
5. **Confettis conditionnels** - Uniquement score parfait

**ProblÃ¨mes rÃ©solus :**

1. **Double lecture audio au dÃ©marrage**
   - Cause : demarrerExercice() appelait playAudio() + useEffect appelait aussi playAudio()
   - Solution : Supprimer playAudio() de demarrerExercice(), laisser UNIQUEMENT useEffect
   ```javascript
   // âŒ PAS DE playAudio ici â†’ le useEffect (ligne 87) s'en charge
   ```

2. **Cascade audio ne trouve pas les enregistrements perso**
   - Cause : API retourne `{ "bonjour": {...} }` mais playAudio() cherche avec ponctuation normalisÃ©e
   - Solution : Normaliser les clÃ©s lors du chargement
   ```javascript
   const mapNormalise = {}
   Object.entries(data.enregistrementsMap || {}).forEach(([mot, enreg]) => {
       const motNormalise = mot.toLowerCase().trim()
           .replace(/^[.,;:!?Â¡Â¿'"Â«Â»\-â€”]+/, '')
           .replace(/[.,;:!?Â¡Â¿'"Â«Â»\-â€”]+$/, '')
       mapNormalise[motNormalise] = enreg
   })
   setEnregistrementsMap(mapNormalise)
   ```

3. **Router.query vide au premier render**
   - Solution : Utiliser router.isReady
   ```javascript
   useEffect(() => {
       if (router.isReady) {
           checkAuth()
       }
   }, [router.isReady, router.query])
   ```

**Structure 3 pages (lis-et-trouve) :**
```javascript
// INTRO
{etape === 'intro' && (
    <div>
        <input type="range" min="4" max="8" value={nbSons} />
        <button onClick={startGame}>DÃ©marrer</button>
    </div>
)}

// EXERCICE
{etape === 'exercice' && (
    // Zone de jeu avec cartes audio
)}

// RÃ‰SULTATS
{etape === 'resultats' && (
    // Score final + confettis si parfait
)}
```

### Code important conservÃ©

**useEffect audio automatique (ecoute-et-trouve ligne 86-102) :**
```javascript
useEffect(() => {
    if (etape === 'exercice' && currentMot) {
        // Au premier dÃ©marrage, attendre enregistrementsMap
        if (completedMots.length === 0 && Object.keys(enregistrementsMap).length === 0) {
            console.log('â³ Attente chargement enregistrements...')
            return
        }

        const timer = setTimeout(() => {
            console.log(`ğŸ¯ Lecture auto - ${Object.keys(enregistrementsMap).length} enregistrements`)
            playAudio(currentMot.mot)
        }, 300)

        return () => clearTimeout(timer)
    }
}, [currentMot, etape, enregistrementsMap])
```

### Ã‰tat des exercices aprÃ¨s cette session

| # | Exercice | Ã‰tat | Fichier |
|---|----------|------|---------|
| 1 | Ma voix, mes mots ğŸ™ï¸ | âœ… Pattern moderne | ma-voix-mes-mots-exercice.js |
| 2 | KaraokÃ© ğŸ¤ | âœ… Pattern moderne | karaoke-exercice.js |
| 3 | Remettre dans l'ordre ğŸ”€ | âœ… Pattern moderne | remettre-dans-ordre-exercice.js |
| 4 | OÃ¹ est-ce ? ğŸ¯ | âœ… Pattern moderne | ou-est-ce-exercice.js |
| 5 | Qu'est-ce ? ğŸ”Š | âœ… Pattern moderne | quest-ce-exercice.js |
| 6 | DÃ©coupage âœ‚ï¸ | âœ… Pattern moderne | decoupage-exercice.js |
| 7 | Ã‰coute et trouve ğŸ¯ | âœ… **NOUVEAU** Pattern moderne | ecoute-et-trouve.js |
| 8 | Lis et trouve ğŸ‘ï¸ | âœ… **NOUVEAU** Pattern moderne | lis-et-trouve.js |
| 9 | Construis phrases ğŸ“ | â¸ï¸ Ancien pattern | construis-phrases/ |

### Notes pour la prochaine session

**Si besoin de continuer :**
- Exercice #9 "Construis phrases" reste Ã  migrer
- Pattern validÃ© et reproductible sur ces 2 exercices
- Toujours vÃ©rifier normalisation enregistrementsMap
- Toujours supprimer playAudio() dans fonction de dÃ©marrage (laisser useEffect seul)

**Tests recommandÃ©s :**
1. Ã‰coute et trouve : Intro â†’ Exercice â†’ Audio auto + cascade â†’ RÃ©sultats
2. Lis et trouve : Intro (4-8 sons) â†’ Exercice â†’ Validation â†’ RÃ©sultats

---

## [2025-11-13 00:30] - ğŸ“‹ PLANIFICATION: Adaptation ecoute-et-trouve.js

### Contexte
DÃ©but de session avec prÃ©paration d'un prompt dÃ©taillÃ© pour adapter `/lire/ecoute-et-trouve.js` au pattern moderne validÃ© (auto-dÃ©marrage, navigation moderne, interface Ã©purÃ©e).

### Ã‰tat actuel
- **Mode Plan activÃ©** - Aucune modification effectuÃ©e
- **RÃ¨gles lues** - 14 rÃ¨gles de travail confirmÃ©es
- **Journal DEV lu** - Session prÃ©cÃ©dente (12/11/2025) analysÃ©e

### DerniÃ¨re session (12/11/2025) - RÃ©sumÃ©
1. âœ… Extraction exercice #6 "DÃ©coupage âœ‚ï¸" (1046 lignes)
2. âœ… Correction API enregistrements (motData.enregistrements)
3. âœ… Repositionnement navigation desktop (icÃ´nes entre titre et score)
4. âœ… Correction parsing JSX (balise </div> manquante)
5. âœ… Suppression cadres blancs + bouton menu (interface Ã©purÃ©e)

### Pattern validÃ© (rÃ©fÃ©rence: decoupage-exercice.js)

**5 piliers du pattern moderne :**

1. **Auto-dÃ©marrage** - Pas de sÃ©lection, dÃ©marrage immÃ©diat via `router.query.texte_ids`
2. **Navigation moderne** - IcÃ´nes entre titre et score (â† ğŸ“– ğŸ  ğŸ”Š)
3. **Audio cascade** - 3 niveaux : Voix perso â†’ ElevenLabs â†’ Web Speech
4. **Interface Ã©purÃ©e** - Pas de cadres blancs, pas de `questionBox`/`decoupageBox`
5. **Confettis conditionnels** - Uniquement si score parfait (bonnes === total)

### Fichier cible identifiÃ©
`/lire/ecoute-et-trouve.js` - Exercice dÃ©jÃ  extrait mais utilise l'ancien pattern (`showIntro`, sÃ©lection de textes)

### Prompt reÃ§u (10 sections)
1. OBJECTIF - Adapter au pattern moderne
2. CONTEXTE - Ancien pattern (showIntro)
3. PATTERN VALIDÃ‰ - 5 piliers dÃ©taillÃ©s
4. MODIFICATIONS Ã€ EFFECTUER - Actions prÃ©cises
5. STRUCTURE FINALE ATTENDUE - Ã‰tats, fonctions, JSX
6. POINTS CRITIQUES - Obligatoires vs Optionnels
7. FICHIERS DE RÃ‰FÃ‰RENCE - decoupage-exercice.js
8. Ã‰TAPES D'EXÃ‰CUTION - 4 phases
9. VALIDATION FINALE - Checklist 9 points
10. NOTES IMPORTANTES - Conservation vs adaptation

### Actions prÃ©vues (NON EXÃ‰CUTÃ‰ES)
1. Analyser `ecoute-et-trouve.js` (lecture code actuel)
2. Lire `decoupage-exercice.js` (rÃ©fÃ©rence pattern)
3. CrÃ©er todo list (TodoWrite)
4. Proposer modifications dÃ©taillÃ©es
5. Attendre approbation utilisateur

### DÃ©cision prise
**Demande de confirmation avant analyse** - Respect rÃ¨gle #5 (Valider avant coder)

### Points clÃ©s Ã  retenir

**Pattern d'auto-dÃ©marrage (extrait de decoupage-exercice.js) :**
```javascript
useEffect(() => {
    if (user && router.query.texte_ids) {
        chargerDonnees()
    }
}, [user, router.query.texte_ids])

async function chargerDonnees() {
    const texteIds = router.query.texte_ids.split(',').map(id => parseInt(id))

    // Charger groupes de sens
    const { data: groupes } = await supabase
        .from('groupes_sens')
        .select('id, texte_reference_id, ordre_groupe, contenu')
        .in('texte_reference_id', texteIds)
        .order('texte_reference_id', { ascending: true })
        .order('ordre_groupe', { ascending: true })

    // Filtrer groupes vides
    const groupesFiltres = (groupes || []).filter(g => {
        const contenuNettoyÃ© = g.contenu.replace(/[\r\n\s]+/g, ' ').trim()
        return contenuNettoyÃ©.length > 0 && contenuNettoyÃ© !== '.'
    })

    // Charger enregistrements
    const motResponse = await fetch(`/api/enregistrements-mots/list?texte_ids=${texteIds.join(',')}`)
    const motData = await motResponse.json()

    const groupeResponse = await fetch(`/api/enregistrements-groupes/list?texte_ids=${texteIds.join(',')}`)
    const groupeData = await groupeResponse.json()

    // âš ï¸ IMPORTANT: API retourne { enregistrements: [...] }
    motData.enregistrements?.forEach(enr => { /* ... */ })
    groupeData.enregistrements?.forEach(enr => { /* ... */ })

    // DÃ©marrer auto (pas de sÃ©lection)
    if (groupesFiltres.length > 0) {
        setTimeout(() => demarrerExercice(groupesFiltres), 100)
    }
}
```

**Navigation moderne (desktop) :**
```javascript
{!isMobile ? (
    <div style={{ width: '100%' }}>
        {/* Titre */}
        <h1 style={styles.title}>âœ‚ï¸ DÃ©coupage</h1>

        {/* Navigation - Entre titre et score */}
        <div style={{
            display: 'flex',
            gap: '8px',
            justifyContent: 'center',
            marginTop: '16px',
            marginBottom: '16px'
        }}>
            <button onClick={() => router.push(`/lire/reconnaitre-les-mots/exercices2?textes=${router.query.texte_ids}`)}>â†</button>
            <button onClick={() => router.push('/lire')}>ğŸ“–</button>
            <button onClick={() => router.push('/dashboard')}>ğŸ </button>
            <button onClick={lireGroupeDeSens}>ğŸ”Š</button>
        </div>

        {/* Score */}
        <p style={styles.subtitle}>
            Phrase {indexGroupe + 1} / {groupesSens.length} â€¢ Score : {score.bonnes}/{score.total}
        </p>
    </div>
) : (
    // Mobile: 6 icÃ´nes en haut
)}
```

**Audio cascade (3 niveaux) :**
```javascript
async function lireTTS(texte, groupeId = null) {
    // Niveau 1: Voix personnalisÃ©e (enregistrements)
    if (groupeId && enregistrementsMap[groupeId]) {
        const audio = new Audio(enregistrementsMap[groupeId].chemin_fichier)
        audio.play()
        return
    }

    // Niveau 2: ElevenLabs
    try {
        await lireTTSElevenLabs(texte)
    } catch (error) {
        // Niveau 3: Web Speech (fallback)
        lireTTSFallback(texte)
    }
}
```

**Interface Ã©purÃ©e :**
- âŒ PAS de `questionBox` (cadre blanc consigne)
- âŒ PAS de `decoupageBox` (cadre blanc zone exercice)
- âœ… Consigne simple : `<p style={styles.consigne}>...</p>` (fond bleu clair)
- âœ… Zone exercice : `<div style={{ padding, textAlign, fontSize }}>...</div>` (transparent)

**Confettis conditionnels :**
```javascript
// âœ… UNIQUEMENT si score parfait
useEffect(() => {
    if (etatExercice === 'resultats' && score.bonnes === score.total) {
        confetti({
            particleCount: 100,
            spread: 70,
            origin: { y: 0.6 }
        })
    }
}, [etatExercice, score])

// âŒ PAS aprÃ¨s chaque bonne rÃ©ponse
```

### PiÃ¨ges Ã  Ã©viter

1. **API enregistrements** - Retourne `{ enregistrements: [...] }` et non un tableau direct
   - âŒ `motData.forEach(...)`
   - âœ… `motData.enregistrements?.forEach(...)`

2. **Noms colonnes Supabase** - Table `groupes_sens`
   - âœ… `texte_reference_id`, `ordre_groupe`
   - âŒ PAS `texte_id` ni `ordre`

3. **Ã‰tat initial** - Toujours `'chargement'` (pas de `'selection'`)
   ```javascript
   const [etatExercice, setEtatExercice] = useState('chargement')
   ```

4. **Structure JSX** - VÃ©rifier fermeture des balises
   - Mobile : `<div outer><div title/score><div buttons/></div></div>`
   - Desktop : `<div><title><nav><score></div>`

5. **Suppression bloc sÃ©lection** - Ne pas garder de code mort
   - âŒ Supprimer tout le JSX de sÃ©lection de textes
   - âŒ Supprimer `showIntro`, `setShowIntro`, etc.

### Ã‰tat des exercices (aprÃ¨s session 12/11)

| # | Exercice | Ã‰tat | Fichier cible |
|---|----------|------|---------------|
| 1 | Ma voix, mes mots ğŸ™ï¸ | âœ… Pattern moderne | `ma-voix-mes-mots-exercice.js` |
| 2 | KaraokÃ© ğŸ¤ | âœ… Pattern moderne | `karaoke-exercice.js` |
| 3 | Remettre dans l'ordre ğŸ”€ | âœ… Pattern moderne | `remettre-dans-ordre-exercice.js` |
| 4 | OÃ¹ est-ce ? ğŸ¯ | âœ… Pattern moderne | `ou-est-ce-exercice.js` |
| 5 | Qu'est-ce ? ğŸ”Š | âœ… Pattern moderne | `quest-ce-exercice.js` |
| 6 | DÃ©coupage âœ‚ï¸ | âœ… Pattern moderne | `decoupage-exercice.js` |
| 7 | Ã‰coute et trouve ğŸ¯ | â¸ï¸ **Ã€ ADAPTER** | `ecoute-et-trouve.js` â† CIBLE |
| 8 | Lis et trouve ğŸ‘ï¸ | â¸ï¸ Ancien pattern | `lis-et-trouve.js` |
| 9 | Construis phrases ğŸ“ | â¸ï¸ Ancien pattern | `construis-phrases/` |

### Prochaine Ã©tape
**Attente confirmation utilisateur** pour dÃ©marrer l'analyse et adaptation de `ecoute-et-trouve.js`.

---

**Session en cours - Mode Plan actif** ğŸ“‹â¸ï¸

