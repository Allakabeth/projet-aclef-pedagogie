# Journal de DÃ©veloppement - 13/11/2025

---

## [2025-11-14 02:15] - Fix: Cascade audio + Navigation + Styles boutons - Remettre dans l'ordre

### Fichier modifiÃ©
- `pages/lire/remettre-dans-ordre-exercice.js` - Correction cascade audio, navigation et styles

### Modifications

**Cascade audio (Voix perso > ElevenLabs > Web Speech) :**
- âœ… Chargement enregistrements via API `/api/enregistrements-mots/list?texte_ids=...` au lieu de Supabase direct
- âœ… Ajout header `Authorization: Bearer ${token}` dans les appels API (lignes 111-116, 148-153)
- âœ… Normalisation des clÃ©s `enregistrementsMap` (suppression ponctuation dÃ©but/fin) - lignes 122-127
- âœ… Correction champ `groupe_sens_id` au lieu de `groupe_id` (ligne 164)
- âœ… DÃ©placement des appels depuis `checkAuth()` vers `chargerGroupesSens()` avec `texte_ids`
- âœ… Fonction `lireGroupeDeSens()` : lecture mot par mot forcÃ©e (pas de groupe complet) - lignes 329-335

**Navigation :**
- âœ… Å’il (ğŸ‘ï¸) pointe vers `/lire/reconnaitre-les-mots` au lieu de `/lire/reconnaitre-les-mots-new` (3 occurrences)
- âœ… Page rÃ©sultats desktop : ajout des 5 icÃ´nes de navigation (â† ğŸ‘ï¸ ğŸ“– ğŸ  ğŸ”„) - lignes 1188-1269

**Styles boutons :**
- âœ… Bouton "VÃ©rifier" : fond blanc, bord vert `#10b981`, texte vert gras - lignes 1002-1019
- âœ… Bouton "Phrase suivante" : fond blanc, bord bleu `#3b82f6`, texte bleu gras - lignes 1021-1040

### Code important

**Chargement enregistrements via API (lignes 107-138) :**
```javascript
async function loadEnregistrements(texteIds) {
    const token = localStorage.getItem('token')
    const response = await fetch(`/api/enregistrements-mots/list?texte_ids=${texteIds.join(',')}`, {
        headers: {
            'Authorization': `Bearer ${token}`  // âœ… TOKEN REQUIS
        }
    })
    const data = await response.json()

    if (data && data.enregistrements) {  // âœ… data.enregistrements (pas data direct)
        const map = {}
        data.enregistrements.forEach(enr => {
            // Normaliser la clÃ© comme dans lireTTS()
            const motNormalise = enr.mot.toLowerCase().trim()
                .replace(/^[.,;:!?Â¡Â¿'"Â«Â»\-â€”]+/, '')
                .replace(/[.,;:!?Â¡Â¿'"Â«Â»\-â€”]+$/, '')
            map[motNormalise] = enr
        })
        setEnregistrementsMap(map)
    }
}
```

**Chargement enregistrements groupes (lignes 144-174) :**
```javascript
async function loadEnregistrementsGroupes(texteIds) {
    const token = localStorage.getItem('token')
    const response = await fetch(`/api/enregistrements-groupes/list?texte_ids=${texteIds.join(',')}`, {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    const data = await response.json()

    if (data && data.enregistrements) {
        const map = {}
        data.enregistrements.forEach(enr => {
            map[enr.groupe_sens_id] = enr  // âœ… groupe_sens_id (pas groupe_id)
        })
        setEnregistrementsGroupesMap(map)
    }
}
```

**Lecture mot par mot forcÃ©e (lignes 329-335) :**
```javascript
async function lireGroupeDeSens() {
    if (!groupeActuel) return

    // Lecture mot par mot avec cascade audio (Voix perso > ElevenLabs > Web Speech)
    console.log(`ğŸ”Š Lecture mot par mot du groupe ${groupeActuel.id}`)
    lireGroupeMotParMot()
}
```

**Bouton VÃ©rifier (lignes 1002-1019) :**
```javascript
<button
    onClick={verifierOrdre}
    disabled={motsSelectionnes.length === 0 || feedback !== null || isVerifying}
    style={{
        backgroundColor: 'white',      // âœ… Fond blanc
        color: '#10b981',              // âœ… Texte vert
        border: '2px solid #10b981',   // âœ… Bord vert
        fontWeight: 'bold',            // âœ… Gras
        ...
    }}
>
    VÃ©rifier
</button>
```

### Commit
- SHA: `1f879c1`
- Message: "Fix: Cascade audio + Navigation + Styles boutons - Remettre dans l'ordre"
- Lignes: +177 -64
- Branche: `refonte-reconnaitre-mots`

### Notes
- ProblÃ¨me rÃ©solu : enregistrements personnalisÃ©s n'Ã©taient pas chargÃ©s (manquait token + mauvais champ)
- MÃªme fix que `ecoute-et-trouve.js` et `lis-et-trouve.js` (normalisation clÃ©s)
- Navigation cohÃ©rente avec les autres exercices du module
- Styles boutons uniformisÃ©s (outline style)

---

## [2025-11-13 23:09] - UI: KaraokÃ© - Refonte couleurs jaune/marron

### Fichier modifiÃ©
- `pages/lire/karaoke-exercice.js` - Refonte complÃ¨te des couleurs (thÃ¨me jaune/marron)

### Modifications

**Suppression cadre blanc :**
- âœ… `karaokeBox` (desktop) : suppression backgroundColor, borderRadius, boxShadow, backdropFilter
- âœ… `karaokeBoxMobile` (mobile) : suppression backgroundColor, borderRadius, boxShadow
- âœ… Texte affichÃ© directement sur fond blanc de la page (interface Ã©purÃ©e)

**Bouton "Jouer" (primaryButton - ligne 866) :**
- âœ… Fond jaune `#fef08a` (au lieu de gradient rose)
- âœ… Texte marron `#78350f`
- âœ… Bordure marron `2px solid #78350f`
- âœ… Suppression boxShadow rose

**Mot illuminÃ© Desktop (motIllumine - ligne 825) :**
- âœ… Fond jaune `#fef08a`
- âœ… Texte marron `#78350f`
- âœ… Bordure marron `2px solid #78350f`
- âœ… Suppression boxShadow rose

**Mot principal Mobile (motPrincipalMobile - ligne 835) :**
- âœ… Fond jaune `#fef08a`
- âœ… Texte marron `#78350f`
- âœ… Bordure marron `2px solid #78350f`
- âœ… Suppression boxShadow rose

### Code important

**Bouton Jouer (ligne 866-876) :**
```javascript
primaryButton: {
    padding: '16px 32px',
    background: '#fef08a',  // Jaune
    color: '#78350f',  // Marron
    border: '2px solid #78350f',  // Bordure marron
    borderRadius: '12px',
    fontSize: '18px',
    fontWeight: '600',
    cursor: 'pointer',
    transition: 'all 0.2s'
}
```

**Mot illuminÃ© Desktop (ligne 825-834) :**
```javascript
motIllumine: {
    fontSize: '56px',
    fontWeight: 'bold',
    color: '#78350f',  // Marron
    background: '#fef08a',  // Jaune
    border: '2px solid #78350f',  // Bordure marron
    borderRadius: '12px',
    padding: '12px 24px',
    transform: 'scale(1.1)'
}
```

**Mot principal Mobile (ligne 835-846) :**
```javascript
motPrincipalMobile: {
    fontSize: '64px',
    fontWeight: 'bold',
    color: '#78350f',  // Marron
    background: '#fef08a',  // Jaune
    border: '2px solid #78350f',  // Bordure marron
    borderRadius: '16px',
    padding: '24px',
    textAlign: 'center',
    width: '100%',
    wordBreak: 'break-word'
}
```

### Commit
- SHA: `1918018`
- Message: "UI: KaraokÃ© - Refonte couleurs jaune/marron"
- Lignes: +9 -17
- Branche: `refonte-reconnaitre-mots`

### Notes
- CohÃ©rence visuelle avec le thÃ¨me jaune/marron des autres exercices
- Interface plus Ã©purÃ©e sans cadres blancs redondants
- AmÃ©lioration de la lisibilitÃ© (contraste marron/jaune)

---

## [2025-11-13 23:45] - UI: Ma voix mes mots - Optimisation interface desktop

### Fichier modifiÃ©
- `pages/lire/ma-voix-mes-mots-exercice.js` - Refonte complÃ¨te interface desktop

### Modifications

**Navigation et flÃ¨ches :**
- âœ… FlÃ¨ches navigation mot par mot (style mobile: gradient violet, compactes 8px/12px padding)
- âœ… Suppression `flex: 1` du groupe de sens â†’ flÃ¨ches collÃ©es au texte
- âœ… RÃ©duction gap : 8px â†’ 4px (puis retour 8px pour espacement optimal)
- âœ… Ajout bouton ğŸ”Š violet dans navigation desktop pour lire groupe de sens

**Highlighting mot sÃ©lectionnÃ© :**
- âœ… Cadre jaune arrondi (`#fef3c7` background, `#92400e` couleur, `12px` borderRadius)
- âœ… Padding `8px 12px` (mobile + desktop) pour centrage
- âœ… `display: inline-block` pour que le cadre encadre bien le mot

**Espacement mots :**
- âœ… Desktop : `marginRight: 12px` entre chaque mot du groupe de sens
- âœ… Suppression espace conditionnel (gÃ©rÃ© par margin)

**Refonte boutons :**
- âœ… Suppression bouton "Ma voix" (redondant avec cascade audio)
- âœ… Bouton "Ã‰couter" conditionnel :
  - ğŸŸ¢ Vert (`#10b981`) = Voix IA/ordinateur (pas encore enregistrÃ©)
  - ğŸ”µ Bleu (`#3b82f6`) = Voix personnalisÃ©e (dÃ©jÃ  enregistrÃ©)
- âœ… Tous boutons en outline : fond blanc, bords colorÃ©s 2px
  - Ã‰couter : vert ou bleu (conditionnel)
  - Enregistrer : rouge (`#ef4444`)
  - Recommencer : orange (`#f59e0b`)

### Code important

**FlÃ¨ches navigation desktop (ligne 813-827) :**
```javascript
<div style={{ display: 'flex', alignItems: 'center', gap: '8px', justifyContent: 'center', marginTop: '12px' }}>
    <button
        onClick={() => setIndexMotActuel(Math.max(0, indexMotActuel - 1))}
        disabled={indexMotActuel === 0}
        style={{
            ...styles.navButton,  // Gradient violet
            opacity: indexMotActuel === 0 ? 0.3 : 1,
            cursor: indexMotActuel === 0 ? 'not-allowed' : 'pointer'
        }}
    >
        â†
    </button>
    {/* Groupe de sens */}
    <button>â†’</button>
</div>
```

**Mot sÃ©lectionnÃ© avec cadre jaune (ligne 840-850) :**
```javascript
<span key={idx} style={{
    backgroundColor: isCurrentWord ? '#fef3c7' : 'transparent',
    color: isCurrentWord ? '#92400e' : '#666',
    fontWeight: isCurrentWord ? 'bold' : 'normal',
    padding: isCurrentWord ? '8px 12px' : '0',
    borderRadius: '12px',
    display: 'inline-block',
    marginRight: '12px'  // Espacement mots desktop
}}>
    {mot}
</span>
```

**Bouton Ã‰couter conditionnel (ligne 983-1004) :**
```javascript
<button
    onClick={() => lireTTS(mot)}
    style={{
        background: 'white',
        color: dejaEnregistre ? '#3b82f6' : '#10b981',  // Bleu si perso, vert si IA
        border: `2px solid ${dejaEnregistre ? '#3b82f6' : '#10b981'}`,
        borderRadius: '10px',
        padding: '12px 16px',
        fontSize: '15px',
        fontWeight: '600',
        cursor: 'pointer',
        transition: 'transform 0.2s'
    }}
>
    ğŸ”Š Ã‰couter
</button>
```

**Bouton Ã‰couter groupe (ligne 793-808) :**
```javascript
<button
    onClick={lireGroupeDeSens}
    style={{
        padding: '8px 12px',
        backgroundColor: 'white',
        border: '2px solid #8b5cf6',  // Violet
        borderRadius: '8px',
        cursor: 'pointer',
        fontSize: '20px'
    }}
    title="Ã‰couter le groupe de sens"
>
    ğŸ”Š
</button>
```

### Commit
- SHA: `b32c78e`
- Message: "UI: Ma voix mes mots - Optimisation interface desktop"
- Lignes: +94 -105
- Branche: `refonte-reconnaitre-mots`

### Notes
- UX amÃ©liorÃ©e : feedback visuel immÃ©diat (couleur bouton = type de voix)
- Interface Ã©purÃ©e : 1 bouton au lieu de 2 (suppression redondance)
- Navigation desktop complÃ¨te : â† ğŸ‘ï¸ ğŸ“– ğŸ  ğŸ”Š â†’
- Responsive maintenu sur toutes modifications

---

## [2025-11-13 21:58] - UI: Grille exercices responsive + IcÃ´nes optimisÃ©es

### Fichier modifiÃ©
- `pages/lire/reconnaitre-les-mots/exercices2.js` - Grille responsive et optimisations UI

### Modifications
- âœ… Grille 3Ã—3 responsive : 90px (mobile < 768px), 200px (desktop)
- âœ… Suppression descriptions des cartes (mobile + desktop) pour clartÃ©
- âœ… Polices adaptatives : icÃ´nes 32px/48px, titres 11px/16px
- âœ… Gap adaptatif : 10px mobile, 20px desktop
- âœ… Padding/BorderRadius adaptatifs
- âœ… Correction bouton retour (â†) : pointe vers `/lire/reconnaitre-les-mots` au lieu de `/lire/reconnaitre-les-mots-new` (inexistant)
- âœ… Remplacement icÃ´nes : ğŸ¯â†’ğŸ‘‚ (Ã‰coute et trouve), ğŸ‘ï¸â†’ğŸ‘€ (Lis et trouve)

### Code important
```javascript
// DÃ©tection mobile
const [isMobile, setIsMobile] = useState(false)

useEffect(() => {
    const checkMobile = () => {
        setIsMobile(window.innerWidth < 768)
    }
    checkMobile()
    window.addEventListener('resize', checkMobile)
    return () => window.removeEventListener('resize', checkMobile)
}, [])

// Grille responsive
gridTemplateColumns: isMobile ? '90px 90px 90px' : '200px 200px 200px',
gridTemplateRows: isMobile ? '90px 90px 90px' : '200px 200px 200px',
gap: isMobile ? '10px' : '20px',
```

### Commit
- SHA: `01d44ec`
- Message: "UI: Grille exercices responsive + IcÃ´nes optimisÃ©es"
- Lignes: +30 -19
- Branche: `refonte-reconnaitre-mots`

### Notes
- Les 9 exercices tiennent dÃ©sormais sur mobile sans dÃ©border (290px de large pour 320px d'Ã©cran)
- Interface plus Ã©purÃ©e sans descriptions
- Navigation corrigÃ©e (erreur de parsing rÃ©solue)

---

## [2025-11-13 03:15] - ğŸ’¾ SAUVEGARDE: Migration pattern moderne - Ã‰coute et trouve + Lis et trouve

âš ï¸ **Sauvegarde avant compactage de conversation (38% tokens restants)**

### Contexte
Session intensive de migration de 2 exercices vers le pattern moderne validÃ©. Conversation longue avec beaucoup de modifications successives.

### Fichiers modifiÃ©s

**1. `/lire/ecoute-et-trouve.js` - TERMINÃ‰ âœ…**
- Migration complÃ¨te vers pattern moderne
- Corrections cascade audio + double lecture
- Page intro rÃ©tablie avec slider 4-12 mots

**2. `/lire/lis-et-trouve.js` - TERMINÃ‰ âœ…**
- Migration complÃ¨te vers pattern moderne (3 pages sÃ©parÃ©es)
- Normalisation enregistrementsMap
- Auto-chargement via texte_ids

**3. `/lire/reconnaitre-les-mots/exercices2.js`**
- Carte #7 "Ã‰coute et trouve" activÃ©e
- Carte #8 "Lis et trouve" activÃ©e

### Travail terminÃ©

**Ã‰coute et trouve (exercice #7) :**
- âœ… Suppression double lecture audio (ligne 342 dans demarrerExercice)
- âœ… RÃ©tablissement page intro avec slider 4-12 mots
- âœ… Normalisation clÃ©s enregistrementsMap pour cascade audio
- âœ… Pattern moderne : etape (chargement/intro/exercice/resultats)
- âœ… Auto-chargement mots via router.query.texte_ids
- âœ… router.isReady pour Ã©viter double chargement
- âœ… Suppression score en double (desktop)
- âœ… Suppression 3 boutons desktop (Ã‰couter, ArrÃªter, Retour)

**Lis et trouve (exercice #8) :**
- âœ… Migration 3 pages sÃ©parÃ©es (intro â†’ exercice â†’ rÃ©sultats)
- âœ… Ã‰tat etape ajoutÃ© (chargement/intro/exercice/resultats)
- âœ… Auto-chargement mots dans checkAuth()
- âœ… Normalisation enregistrementsMap (mÃªme fix que Ã©coute-et-trouve)
- âœ… Modification startGame() pour utiliser allMots dÃ©jÃ  chargÃ©
- âœ… Condition JSX : etape === 'intro' / 'exercice' / 'resultats'
- âœ… router.isReady ajoutÃ©
- âœ… Confettis sur etape === 'resultats'
- âœ… Carte #8 activÃ©e dans exercices2.js

### Points clÃ©s Ã  retenir

**Pattern moderne (5 piliers) :**
1. **Auto-dÃ©marrage** - router.query.texte_ids â†’ charger mots â†’ afficher intro
2. **Navigation moderne** - IcÃ´nes entre titre et score (â† ğŸ‘ï¸ ğŸ“– ğŸ  ğŸ”Š)
3. **Audio cascade** - Voix perso > ElevenLabs > Web Speech (pas Hortense)
4. **Interface Ã©purÃ©e** - Pas de cadres blancs inutiles
5. **Confettis conditionnels** - Uniquement score parfait

**ProblÃ¨mes rÃ©solus :**

1. **Double lecture audio au dÃ©marrage**
   - Cause : demarrerExercice() appelait playAudio() + useEffect appelait aussi playAudio()
   - Solution : Supprimer playAudio() de demarrerExercice(), laisser UNIQUEMENT useEffect
   ```javascript
   // âŒ PAS DE playAudio ici â†’ le useEffect (ligne 87) s'en charge
   ```

2. **Cascade audio ne trouve pas les enregistrements perso**
   - Cause : API retourne `{ "bonjour": {...} }` mais playAudio() cherche avec ponctuation normalisÃ©e
   - Solution : Normaliser les clÃ©s lors du chargement
   ```javascript
   const mapNormalise = {}
   Object.entries(data.enregistrementsMap || {}).forEach(([mot, enreg]) => {
       const motNormalise = mot.toLowerCase().trim()
           .replace(/^[.,;:!?Â¡Â¿'"Â«Â»\-â€”]+/, '')
           .replace(/[.,;:!?Â¡Â¿'"Â«Â»\-â€”]+$/, '')
       mapNormalise[motNormalise] = enreg
   })
   setEnregistrementsMap(mapNormalise)
   ```

3. **Router.query vide au premier render**
   - Solution : Utiliser router.isReady
   ```javascript
   useEffect(() => {
       if (router.isReady) {
           checkAuth()
       }
   }, [router.isReady, router.query])
   ```

**Structure 3 pages (lis-et-trouve) :**
```javascript
// INTRO
{etape === 'intro' && (
    <div>
        <input type="range" min="4" max="8" value={nbSons} />
        <button onClick={startGame}>DÃ©marrer</button>
    </div>
)}

// EXERCICE
{etape === 'exercice' && (
    // Zone de jeu avec cartes audio
)}

// RÃ‰SULTATS
{etape === 'resultats' && (
    // Score final + confettis si parfait
)}
```

### Code important conservÃ©

**useEffect audio automatique (ecoute-et-trouve ligne 86-102) :**
```javascript
useEffect(() => {
    if (etape === 'exercice' && currentMot) {
        // Au premier dÃ©marrage, attendre enregistrementsMap
        if (completedMots.length === 0 && Object.keys(enregistrementsMap).length === 0) {
            console.log('â³ Attente chargement enregistrements...')
            return
        }

        const timer = setTimeout(() => {
            console.log(`ğŸ¯ Lecture auto - ${Object.keys(enregistrementsMap).length} enregistrements`)
            playAudio(currentMot.mot)
        }, 300)

        return () => clearTimeout(timer)
    }
}, [currentMot, etape, enregistrementsMap])
```

### Ã‰tat des exercices aprÃ¨s cette session

| # | Exercice | Ã‰tat | Fichier |
|---|----------|------|---------|
| 1 | Ma voix, mes mots ğŸ™ï¸ | âœ… Pattern moderne | ma-voix-mes-mots-exercice.js |
| 2 | KaraokÃ© ğŸ¤ | âœ… Pattern moderne | karaoke-exercice.js |
| 3 | Remettre dans l'ordre ğŸ”€ | âœ… Pattern moderne | remettre-dans-ordre-exercice.js |
| 4 | OÃ¹ est-ce ? ğŸ¯ | âœ… Pattern moderne | ou-est-ce-exercice.js |
| 5 | Qu'est-ce ? ğŸ”Š | âœ… Pattern moderne | quest-ce-exercice.js |
| 6 | DÃ©coupage âœ‚ï¸ | âœ… Pattern moderne | decoupage-exercice.js |
| 7 | Ã‰coute et trouve ğŸ¯ | âœ… **NOUVEAU** Pattern moderne | ecoute-et-trouve.js |
| 8 | Lis et trouve ğŸ‘ï¸ | âœ… **NOUVEAU** Pattern moderne | lis-et-trouve.js |
| 9 | Construis phrases ğŸ“ | â¸ï¸ Ancien pattern | construis-phrases/ |

### Notes pour la prochaine session

**Si besoin de continuer :**
- Exercice #9 "Construis phrases" reste Ã  migrer
- Pattern validÃ© et reproductible sur ces 2 exercices
- Toujours vÃ©rifier normalisation enregistrementsMap
- Toujours supprimer playAudio() dans fonction de dÃ©marrage (laisser useEffect seul)

**Tests recommandÃ©s :**
1. Ã‰coute et trouve : Intro â†’ Exercice â†’ Audio auto + cascade â†’ RÃ©sultats
2. Lis et trouve : Intro (4-8 sons) â†’ Exercice â†’ Validation â†’ RÃ©sultats

---

## [2025-11-13 00:30] - ğŸ“‹ PLANIFICATION: Adaptation ecoute-et-trouve.js

### Contexte
DÃ©but de session avec prÃ©paration d'un prompt dÃ©taillÃ© pour adapter `/lire/ecoute-et-trouve.js` au pattern moderne validÃ© (auto-dÃ©marrage, navigation moderne, interface Ã©purÃ©e).

### Ã‰tat actuel
- **Mode Plan activÃ©** - Aucune modification effectuÃ©e
- **RÃ¨gles lues** - 14 rÃ¨gles de travail confirmÃ©es
- **Journal DEV lu** - Session prÃ©cÃ©dente (12/11/2025) analysÃ©e

### DerniÃ¨re session (12/11/2025) - RÃ©sumÃ©
1. âœ… Extraction exercice #6 "DÃ©coupage âœ‚ï¸" (1046 lignes)
2. âœ… Correction API enregistrements (motData.enregistrements)
3. âœ… Repositionnement navigation desktop (icÃ´nes entre titre et score)
4. âœ… Correction parsing JSX (balise </div> manquante)
5. âœ… Suppression cadres blancs + bouton menu (interface Ã©purÃ©e)

### Pattern validÃ© (rÃ©fÃ©rence: decoupage-exercice.js)

**5 piliers du pattern moderne :**

1. **Auto-dÃ©marrage** - Pas de sÃ©lection, dÃ©marrage immÃ©diat via `router.query.texte_ids`
2. **Navigation moderne** - IcÃ´nes entre titre et score (â† ğŸ“– ğŸ  ğŸ”Š)
3. **Audio cascade** - 3 niveaux : Voix perso â†’ ElevenLabs â†’ Web Speech
4. **Interface Ã©purÃ©e** - Pas de cadres blancs, pas de `questionBox`/`decoupageBox`
5. **Confettis conditionnels** - Uniquement si score parfait (bonnes === total)

### Fichier cible identifiÃ©
`/lire/ecoute-et-trouve.js` - Exercice dÃ©jÃ  extrait mais utilise l'ancien pattern (`showIntro`, sÃ©lection de textes)

### Prompt reÃ§u (10 sections)
1. OBJECTIF - Adapter au pattern moderne
2. CONTEXTE - Ancien pattern (showIntro)
3. PATTERN VALIDÃ‰ - 5 piliers dÃ©taillÃ©s
4. MODIFICATIONS Ã€ EFFECTUER - Actions prÃ©cises
5. STRUCTURE FINALE ATTENDUE - Ã‰tats, fonctions, JSX
6. POINTS CRITIQUES - Obligatoires vs Optionnels
7. FICHIERS DE RÃ‰FÃ‰RENCE - decoupage-exercice.js
8. Ã‰TAPES D'EXÃ‰CUTION - 4 phases
9. VALIDATION FINALE - Checklist 9 points
10. NOTES IMPORTANTES - Conservation vs adaptation

### Actions prÃ©vues (NON EXÃ‰CUTÃ‰ES)
1. Analyser `ecoute-et-trouve.js` (lecture code actuel)
2. Lire `decoupage-exercice.js` (rÃ©fÃ©rence pattern)
3. CrÃ©er todo list (TodoWrite)
4. Proposer modifications dÃ©taillÃ©es
5. Attendre approbation utilisateur

### DÃ©cision prise
**Demande de confirmation avant analyse** - Respect rÃ¨gle #5 (Valider avant coder)

### Points clÃ©s Ã  retenir

**Pattern d'auto-dÃ©marrage (extrait de decoupage-exercice.js) :**
```javascript
useEffect(() => {
    if (user && router.query.texte_ids) {
        chargerDonnees()
    }
}, [user, router.query.texte_ids])

async function chargerDonnees() {
    const texteIds = router.query.texte_ids.split(',').map(id => parseInt(id))

    // Charger groupes de sens
    const { data: groupes } = await supabase
        .from('groupes_sens')
        .select('id, texte_reference_id, ordre_groupe, contenu')
        .in('texte_reference_id', texteIds)
        .order('texte_reference_id', { ascending: true })
        .order('ordre_groupe', { ascending: true })

    // Filtrer groupes vides
    const groupesFiltres = (groupes || []).filter(g => {
        const contenuNettoyÃ© = g.contenu.replace(/[\r\n\s]+/g, ' ').trim()
        return contenuNettoyÃ©.length > 0 && contenuNettoyÃ© !== '.'
    })

    // Charger enregistrements
    const motResponse = await fetch(`/api/enregistrements-mots/list?texte_ids=${texteIds.join(',')}`)
    const motData = await motResponse.json()

    const groupeResponse = await fetch(`/api/enregistrements-groupes/list?texte_ids=${texteIds.join(',')}`)
    const groupeData = await groupeResponse.json()

    // âš ï¸ IMPORTANT: API retourne { enregistrements: [...] }
    motData.enregistrements?.forEach(enr => { /* ... */ })
    groupeData.enregistrements?.forEach(enr => { /* ... */ })

    // DÃ©marrer auto (pas de sÃ©lection)
    if (groupesFiltres.length > 0) {
        setTimeout(() => demarrerExercice(groupesFiltres), 100)
    }
}
```

**Navigation moderne (desktop) :**
```javascript
{!isMobile ? (
    <div style={{ width: '100%' }}>
        {/* Titre */}
        <h1 style={styles.title}>âœ‚ï¸ DÃ©coupage</h1>

        {/* Navigation - Entre titre et score */}
        <div style={{
            display: 'flex',
            gap: '8px',
            justifyContent: 'center',
            marginTop: '16px',
            marginBottom: '16px'
        }}>
            <button onClick={() => router.push(`/lire/reconnaitre-les-mots/exercices2?textes=${router.query.texte_ids}`)}>â†</button>
            <button onClick={() => router.push('/lire')}>ğŸ“–</button>
            <button onClick={() => router.push('/dashboard')}>ğŸ </button>
            <button onClick={lireGroupeDeSens}>ğŸ”Š</button>
        </div>

        {/* Score */}
        <p style={styles.subtitle}>
            Phrase {indexGroupe + 1} / {groupesSens.length} â€¢ Score : {score.bonnes}/{score.total}
        </p>
    </div>
) : (
    // Mobile: 6 icÃ´nes en haut
)}
```

**Audio cascade (3 niveaux) :**
```javascript
async function lireTTS(texte, groupeId = null) {
    // Niveau 1: Voix personnalisÃ©e (enregistrements)
    if (groupeId && enregistrementsMap[groupeId]) {
        const audio = new Audio(enregistrementsMap[groupeId].chemin_fichier)
        audio.play()
        return
    }

    // Niveau 2: ElevenLabs
    try {
        await lireTTSElevenLabs(texte)
    } catch (error) {
        // Niveau 3: Web Speech (fallback)
        lireTTSFallback(texte)
    }
}
```

**Interface Ã©purÃ©e :**
- âŒ PAS de `questionBox` (cadre blanc consigne)
- âŒ PAS de `decoupageBox` (cadre blanc zone exercice)
- âœ… Consigne simple : `<p style={styles.consigne}>...</p>` (fond bleu clair)
- âœ… Zone exercice : `<div style={{ padding, textAlign, fontSize }}>...</div>` (transparent)

**Confettis conditionnels :**
```javascript
// âœ… UNIQUEMENT si score parfait
useEffect(() => {
    if (etatExercice === 'resultats' && score.bonnes === score.total) {
        confetti({
            particleCount: 100,
            spread: 70,
            origin: { y: 0.6 }
        })
    }
}, [etatExercice, score])

// âŒ PAS aprÃ¨s chaque bonne rÃ©ponse
```

### PiÃ¨ges Ã  Ã©viter

1. **API enregistrements** - Retourne `{ enregistrements: [...] }` et non un tableau direct
   - âŒ `motData.forEach(...)`
   - âœ… `motData.enregistrements?.forEach(...)`

2. **Noms colonnes Supabase** - Table `groupes_sens`
   - âœ… `texte_reference_id`, `ordre_groupe`
   - âŒ PAS `texte_id` ni `ordre`

3. **Ã‰tat initial** - Toujours `'chargement'` (pas de `'selection'`)
   ```javascript
   const [etatExercice, setEtatExercice] = useState('chargement')
   ```

4. **Structure JSX** - VÃ©rifier fermeture des balises
   - Mobile : `<div outer><div title/score><div buttons/></div></div>`
   - Desktop : `<div><title><nav><score></div>`

5. **Suppression bloc sÃ©lection** - Ne pas garder de code mort
   - âŒ Supprimer tout le JSX de sÃ©lection de textes
   - âŒ Supprimer `showIntro`, `setShowIntro`, etc.

### Ã‰tat des exercices (aprÃ¨s session 12/11)

| # | Exercice | Ã‰tat | Fichier cible |
|---|----------|------|---------------|
| 1 | Ma voix, mes mots ğŸ™ï¸ | âœ… Pattern moderne | `ma-voix-mes-mots-exercice.js` |
| 2 | KaraokÃ© ğŸ¤ | âœ… Pattern moderne | `karaoke-exercice.js` |
| 3 | Remettre dans l'ordre ğŸ”€ | âœ… Pattern moderne | `remettre-dans-ordre-exercice.js` |
| 4 | OÃ¹ est-ce ? ğŸ¯ | âœ… Pattern moderne | `ou-est-ce-exercice.js` |
| 5 | Qu'est-ce ? ğŸ”Š | âœ… Pattern moderne | `quest-ce-exercice.js` |
| 6 | DÃ©coupage âœ‚ï¸ | âœ… Pattern moderne | `decoupage-exercice.js` |
| 7 | Ã‰coute et trouve ğŸ¯ | â¸ï¸ **Ã€ ADAPTER** | `ecoute-et-trouve.js` â† CIBLE |
| 8 | Lis et trouve ğŸ‘ï¸ | â¸ï¸ Ancien pattern | `lis-et-trouve.js` |
| 9 | Construis phrases ğŸ“ | â¸ï¸ Ancien pattern | `construis-phrases/` |

### Prochaine Ã©tape
**Attente confirmation utilisateur** pour dÃ©marrer l'analyse et adaptation de `ecoute-et-trouve.js`.

---

**Session en cours - Mode Plan actif** ğŸ“‹â¸ï¸

